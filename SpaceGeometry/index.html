<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Geometry Explorer</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=JetBrains+Mono&display=swap');
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #020617;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(30, 58, 138, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(88, 28, 135, 0.2) 0%, transparent 50%);
            color: #f8fafc;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .canvas-container {
            position: relative;
            cursor: crosshair;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* Starfield effect */
        .canvas-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background-image: radial-gradient(1px 1px at 20px 30px, #eee, rgba(0,0,0,0)),
                              radial-gradient(1px 1px at 40px 70px, #fff, rgba(0,0,0,0)),
                              radial-gradient(1px 1px at 50px 160px, #ddd, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 200px 200px;
            opacity: 0.3;
            z-index: 0;
        }

        .handle {
            width: 24px;
            height: 24px;
            background: #60a5fa;
            border: 4px solid #1e293b;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 15px #3b82f6;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 50;
            touch-action: none;
        }

        .handle:hover {
            scale: 1.2;
            background: #f472b6;
            box-shadow: 0 0 20px #db2777;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .nebula-glow {
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(167, 139, 250, 0.3);
        }

        .ai-terminal {
            font-family: 'JetBrains Mono', monospace;
            position: relative;
            overflow: hidden;
        }

        .loading-dots::after {
            content: '...';
            animation: pulse-subtle 1.5s infinite;
        }
        
        @keyframes pulse-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Prevent text selection while dragging */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="p-4 md:p-8 no-select">
    <div class="max-w-7xl mx-auto">
        <header class="mb-10 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 mb-2">
                Nebula Geometry Lab
            </h1>
            <p class="text-slate-400 tracking-widest uppercase text-xs font-bold">Sector 7-G: Area Derivation Module</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Main Engine: The Interactive Canvas -->
            <div class="lg:col-span-2 glass-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-blue-300 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path></svg>
                        Spatial Mapping
                    </h2>
                    <button id="toggle-rect" class="px-4 py-2 bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/30 text-blue-300 rounded-full text-[10px] font-black transition-all uppercase tracking-widest">
                        Toggle Containment Field
                    </button>
                </div>

                <div class="canvas-container h-[400px] md:h-[450px]" id="stage">
                    <canvas id="mainCanvas"></canvas>
                    <div id="h1" class="handle"></div>
                    <div id="h2" class="handle"></div>
                    <div id="h3" class="handle"></div>
                </div>

                <div class="mt-8 grid grid-cols-3 gap-4 md:gap-6">
                    <div class="p-4 bg-blue-900/30 border border-blue-500/20 rounded-2xl text-center">
                        <p class="text-[9px] md:text-[10px] uppercase font-black text-blue-400 mb-1 tracking-widest">Base Vector</p>
                        <p id="val-base" class="text-xl md:text-3xl font-bold text-blue-100 font-mono">0</p>
                    </div>
                    <div class="p-4 bg-purple-900/30 border border-purple-500/20 rounded-2xl text-center">
                        <p class="text-[9px] md:text-[10px] uppercase font-black text-purple-400 mb-1 tracking-widest">Altitude</p>
                        <p id="val-height" class="text-xl md:text-3xl font-bold text-purple-100 font-mono">0</p>
                    </div>
                    <div class="p-4 bg-pink-900/30 border border-pink-500/20 rounded-2xl text-center">
                        <p class="text-[9px] md:text-[10px] uppercase font-black text-pink-400 mb-1 tracking-widest">Sector Mass</p>
                        <p id="val-area" class="text-xl md:text-3xl font-bold text-pink-100 font-mono">0</p>
                    </div>
                </div>
            </div>

            <!-- Theory Core -->
            <div class="flex flex-col gap-6">
                <div class="glass-card p-6 bg-indigo-950/40">
                    <h3 class="text-sm font-black mb-4 text-indigo-400 uppercase tracking-widest">The Core Axiom</h3>
                    <div class="space-y-4">
                        <p class="text-sm leading-relaxed text-slate-300">
                            A star-sector (triangle) is precisely <span class="text-white font-bold underline decoration-indigo-500">50% volume</span> of its rectangular hyper-space.
                        </p>
                        <div class="bg-black/40 p-5 rounded-xl border border-indigo-500/30 text-center">
                            <span class="text-2xl font-mono text-indigo-300 tracking-tighter">
                                A = ½ · b · h
                            </span>
                        </div>
                    </div>
                </div>

                <div id="message-box" class="glass-card p-6 border-l-4 border-cyan-400 bg-cyan-950/20">
                    <h4 class="text-cyan-400 font-black text-[10px] uppercase mb-2 tracking-widest">Mission Logs</h4>
                    <p id="context-msg" class="text-cyan-100 text-sm leading-relaxed font-medium italic">
                        Scanning sector coordinates...
                    </p>
                </div>
            </div>

            <!-- Galactic Navigator (AI) -->
            <div class="flex flex-col gap-6">
                <div class="glass-card p-6 nebula-glow flex flex-col h-full ai-terminal bg-slate-950/80">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"></div>
                        <h3 class="text-sm font-black text-purple-300 uppercase tracking-tighter">Galactic Navigator</h3>
                    </div>
                    
                    <div id="ai-response-area" class="flex-grow overflow-y-auto mb-4 text-xs text-purple-100/80 leading-relaxed scrollbar-hide min-h-[100px]">
                        System ready. Input coordinates for spatial analysis or request a deep-space challenge.
                    </div>

                    <div class="space-y-3">
                        <button id="btn-explain" class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-purple-900/20">
                            Analyze Sector
                        </button>
                        <button id="btn-quiz" class="w-full py-3 border border-purple-500/50 text-purple-300 hover:bg-purple-500/10 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                            New Challenge
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Gemini Configuration ---
        const apiKey = ""; // Runtime provides the key

        // --- Geometric Engine ---
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const stage = document.getElementById('stage');
        const h1 = document.getElementById('h1');
        const h2 = document.getElementById('h2');
        const h3 = document.getElementById('h3');
        const handles = [h1, h2, h3];
        
        const valBase = document.getElementById('val-base');
        const valHeight = document.getElementById('val-height');
        const valArea = document.getElementById('val-area');
        const contextMsg = document.getElementById('context-msg');
        const aiResponse = document.getElementById('ai-response-area');

        let showRect = true;
        let points = [
            { x: 120, y: 350 }, // Base Left
            { x: 400, y: 350 }, // Base Right
            { x: 260, y: 120 }  // Apex
        ];

        function resize() {
            canvas.width = stage.offsetWidth;
            canvas.height = stage.offsetHeight;
            updateUI();
        }

        function updateUI() {
            points.forEach((p, i) => {
                handles[i].style.left = p.x + 'px';
                handles[i].style.top = p.y + 'px';
            });

            const b = Math.abs(points[1].x - points[0].x);
            const h = Math.abs(points[2].y - points[0].y);
            const area = 0.5 * b * h;

            valBase.innerText = (b / 10).toFixed(1);
            valHeight.innerText = (h / 10).toFixed(1);
            valArea.innerText = (area / 100).toFixed(1);

            // Mission Log logic
            if (h < 10) {
                contextMsg.innerText = "Altitude too low for stable mass calculation. Increase Y-axis drift.";
            } else if (points[2].x < Math.min(points[0].x, points[1].x) || points[2].x > Math.max(points[0].x, points[1].x)) {
                contextMsg.innerText = "Apex detected outside base vector. Scalar derivation still valid.";
            } else {
                contextMsg.innerText = "Spatial field stable. Triangle area is exactly 50% of the bounding hyper-rectangle.";
            }

            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Neon Grid
            ctx.strokeStyle = 'rgba(79, 70, 229, 0.1)';
            ctx.lineWidth = 1;
            for(let i=0; i<canvas.width; i+=40) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke(); }
            for(let i=0; i<canvas.height; i+=40) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke(); }

            const minX = Math.min(points[0].x, points[1].x);
            const maxX = Math.max(points[0].x, points[1].x);
            const minY = Math.min(points[2].y, points[0].y);
            const maxY = Math.max(points[2].y, points[0].y);

            if (showRect) {
                ctx.setLineDash([8, 4]);
                ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
                ctx.strokeRect(minX, minY, maxX - minX, maxY - minY);
                ctx.fillStyle = 'rgba(59, 130, 246, 0.05)';
                ctx.fillRect(minX, minY, maxX - minX, maxY - minY);
                ctx.setLineDash([]);
            }

            // Altitude Line (Height)
            ctx.beginPath();
            ctx.setLineDash([3, 3]);
            ctx.strokeStyle = '#a78bfa';
            ctx.moveTo(points[2].x, points[2].y);
            ctx.lineTo(points[2].x, points[0].y);
            ctx.stroke();
            ctx.setLineDash([]);

            // Triangle Field
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            ctx.lineTo(points[1].x, points[1].y);
            ctx.lineTo(points[2].x, points[2].y);
            ctx.closePath();
            
            const grad = ctx.createLinearGradient(0, minY, 0, maxY);
            grad.addColorStop(0, 'rgba(192, 38, 211, 0.4)');
            grad.addColorStop(1, 'rgba(37, 99, 235, 0.2)');
            
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'rgba(139, 92, 246, 0.5)';
            ctx.fillStyle = grad;
            ctx.fill();
            
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.shadowBlur = 0;

            // HUD Labels
            ctx.font = '700 10px JetBrains Mono';
            ctx.fillStyle = '#60a5fa';
            ctx.fillText(`VECTOR B: ${(Math.abs(points[1].x - points[0].x)/10).toFixed(1)}ly`, (points[0].x + points[1].x)/2 - 30, points[0].y + 20);
            ctx.fillStyle = '#a78bfa';
            ctx.fillText(`ALT: ${(Math.abs(points[2].y - points[0].y)/10).toFixed(1)}ly`, points[2].x + 10, (points[2].y + points[0].y)/2);
        }

        // --- Interaction Logic ---
        let activeHandle = null;

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function handleStart(e) {
            const pos = getMousePos(e);
            points.forEach((p, i) => {
                const dist = Math.sqrt((pos.x - p.x)**2 + (pos.y - p.y)**2);
                if (dist < 30) activeHandle = i;
            });
        }

        function handleMove(e) {
            if (activeHandle === null) return;
            const pos = getMousePos(e);

            // Snap/Constraint logic
            if (activeHandle === 0) {
                points[0].x = pos.x;
                points[1].y = points[0].y; // Maintain horizontal base
            } else if (activeHandle === 1) {
                points[1].x = pos.x;
                points[0].y = points[1].y; // Maintain horizontal base
            } else {
                points[2].x = pos.x;
                points[2].y = pos.y;
            }
            updateUI();
        }

        function handleEnd() {
            activeHandle = null;
        }

        window.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        window.addEventListener('touchstart', handleStart, { passive: false });
        window.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, { passive: false });
        window.addEventListener('touchend', handleEnd);
        window.addEventListener('resize', resize);
        
        document.getElementById('toggle-rect').addEventListener('click', () => { 
            showRect = !showRect; 
            updateUI(); 
        });

        // --- AI API Integration (Gemini) ---
        async function callGemini(prompt, systemInstruction) {
            aiResponse.innerHTML = '<span class="text-blue-400 font-bold loading-dots">COMMUNICATING WITH SATELLITE</span>';
            let retries = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];

            const fetchData = async () => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                if (!response.ok) throw new Error('API Transmission Error');
                return response.json();
            };

            while (retries < 5) {
                try {
                    const result = await fetchData();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    aiResponse.innerHTML = text.replace(/\n/g, '<br>');
                    return;
                } catch (e) {
                    await new Promise(r => setTimeout(r, delays[retries]));
                    retries++;
                }
            }
            aiResponse.innerText = "SIGNAL LOST. RECONNECTING TO GALACTIC HUB...";
        }

        document.getElementById('btn-explain').addEventListener('click', () => {
            const b = (Math.abs(points[1].x - points[0].x) / 10).toFixed(1);
            const h = (Math.abs(points[2].y - points[0].y) / 10).toFixed(1);
            const a = (0.5 * b * h).toFixed(1);
            
            const prompt = `Current Coordinates: Base ${b} ly, Altitude ${h} ly. Calculated Mass: ${a} ly². Explain how this sector's area is derived from its containment rectangle using a space exploration metaphor. Explain why it's exactly half.`;
            const system = "You are the Galactic Navigator AI. Use sci-fi metaphors (star charts, fuel density, shield sectors). Keep it encouraging for high school recruits. Be under 50 words.";
            callGemini(prompt, system);
        });

        document.getElementById('btn-quiz').addEventListener('click', () => {
            const prompt = "Generate a spatial reasoning challenge for a navigation recruit about triangles and area. Make it interesting and sci-fi themed.";
            const system = "You are the Flight Instructor. Present a short geometry 'what if' scenario involving triangle area in a space context. Don't reveal the answer immediately.";
            callGemini(prompt, system);
        });

        // Startup
        resize();
        window.onload = () => setTimeout(updateUI, 100);
    </script>
</body>
</html>
