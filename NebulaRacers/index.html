<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula Racers: Classroom Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            background: #020617;
            color: #f8fafc;
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        .space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: twinkle var(--duration) infinite ease-in-out;
        }

        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .ship {
            transition: left 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 10px var(--glow));
            display: flex;
            align-items: center;
            height: 100%;
            top: 0;
            pointer-events: none;
        }

        .track-lane {
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 70px; 
            width: 100%;
        }

        .finish-line {
            background: repeating-conic-gradient(#fff 0% 25%, #000 0% 50%) 50% / 15px 15px;
            width: 40px;
            height: 100%;
            position: absolute;
            right: 120px;
            opacity: 0.4;
            border-left: 2px solid white;
            z-index: 5;
        }

        .glass {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .subject-card {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .subject-card.selected {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
            transform: scale(1.05);
        }

        .finished-glow {
            filter: drop-shadow(0 0 20px #22c55e) !important;
        }
    </style>
</head>
<body>
    <div id="app" class="h-screen w-screen flex flex-col">
        <div class="space-bg" id="stars"></div>

        <!-- Connection Overlay -->
        <div id="connection-overlay" class="fixed inset-0 bg-slate-950 z-[100] flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-500 mb-4"></div>
            <p class="text-cyan-500 font-mono tracking-widest animate-pulse">ESTABLISHING SATELLITE LINK...</p>
        </div>

        <!-- Lobby Screen -->
        <div id="screen-lobby" class="flex-grow flex flex-col items-center justify-center p-4">
            <div class="glass p-8 rounded-3xl w-full max-w-5xl text-center grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h1 class="text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 text-left">NEBULA RACERS</h1>
                    
                    <div id="setup-controls" class="space-y-6 text-left">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-[10px] text-slate-400 uppercase font-bold">Pilot Tag (3 Char)</label>
                                <input type="text" id="player-tag" maxlength="3" value="ACE" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl font-mono text-center uppercase text-white">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] text-slate-400 uppercase font-bold">Hull Color</label>
                                <input type="color" id="player-color" value="#3b82f6" class="w-full h-12 bg-slate-900 border border-slate-700 rounded-xl cursor-pointer">
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <label class="text-[10px] text-slate-400 uppercase font-bold">Mission Subject</label>
                            <div id="subject-list" class="grid grid-cols-3 gap-2">
                                <div class="subject-card glass p-2 rounded-lg text-xs selected" data-subj="Math">Math</div>
                                <div class="subject-card glass p-2 rounded-lg text-xs" data-subj="Science">Science</div>
                                <div class="subject-card glass p-2 rounded-lg text-xs" data-subj="History">History</div>
                                <div class="subject-card glass p-2 rounded-lg text-xs" data-subj="Literature">Literature</div>
                                <div class="subject-card glass p-2 rounded-lg text-xs" data-subj="Pop Culture">Pop Culture</div>
                            </div>
                        </div>

                        <button id="btn-join" class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 rounded-xl font-bold text-xl transition-all shadow-lg text-white">READY TO RACE</button>
                    </div>

                    <div id="lobby-wait" class="hidden mt-8 space-y-6">
                        <div id="player-list" class="flex flex-wrap gap-3 mb-6"></div>
                        <div id="host-controls" class="hidden space-y-2">
                            <button id="btn-start" class="w-full py-4 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold text-xl text-white">LAUNCH SQUADRON</button>
                            <button id="btn-reset" class="w-full py-2 bg-slate-800 hover:bg-red-900/50 rounded-lg text-xs font-bold text-slate-400 hover:text-white transition-colors">RESET CLASSROOM LOBBY</button>
                        </div>
                        <div id="guest-wait">
                            <p class="animate-pulse text-slate-400 font-mono italic">Awaiting Squadron Leader...</p>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Section -->
                <div class="text-left border-l border-slate-700 pl-0 lg:pl-8">
                    <h2 class="text-xl font-bold mb-4 text-yellow-500">GALACTIC HALL OF FAME</h2>
                    <div id="global-leaderboard" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                        <p class="text-slate-500 text-sm">Scanning space-time for records...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Race Screen -->
        <div id="screen-race" class="hidden flex-grow flex flex-col overflow-hidden">
            <div class="glass p-4 flex justify-between items-center border-b border-slate-800">
                <div class="flex items-center gap-6">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-500 uppercase font-bold">Warp Factor</span>
                        <span id="question-count" class="font-mono text-xl text-cyan-400">1 / 10</span>
                    </div>
                    <div id="final-timer-container" class="hidden flex items-center gap-3 px-4 py-2 bg-red-900/30 border border-red-500/50 rounded-xl">
                        <span class="text-red-500 text-xs font-bold animate-pulse">CLEANUP:</span>
                        <span id="final-timer" class="font-mono text-2xl text-white">30s</span>
                    </div>
                </div>
                <div class="text-right">
                    <p id="race-subject-label" class="text-xs text-slate-400 font-bold uppercase"></p>
                    <p id="timer-text" class="font-mono text-lg text-slate-300">00:00.00</p>
                </div>
            </div>

            <div class="flex-grow relative bg-slate-950 flex flex-col overflow-hidden" id="track">
                <!-- Lanes injected here -->
            </div>

            <div id="quiz-ui" class="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-2xl glass p-8 rounded-3xl shadow-2xl z-50">
                <h3 id="question-text" class="text-lg md:text-xl font-bold mb-6 text-center h-16"></h3>
                <div id="options-grid" class="grid grid-cols-2 gap-4"></div>
            </div>

            <div id="penalty-ui" class="hidden absolute inset-0 bg-red-950/80 backdrop-blur-md flex flex-col items-center justify-center z-[60]">
                <h2 class="text-5xl font-bold text-red-500 mb-2 italic">ENGINE STALL</h2>
                <p class="font-mono text-white text-xl">Recalibrating... 5.0s</p>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="screen-results" class="hidden flex-grow flex flex-col items-center justify-center p-4">
            <div class="glass p-10 rounded-3xl w-full max-w-2xl text-center">
                <h1 class="text-4xl font-bold mb-8 text-yellow-400">MISSION DEBRIEF</h1>
                <div id="rankings" class="space-y-4 mb-8"></div>
                <button onclick="location.reload()" class="px-10 py-4 bg-cyan-600 hover:bg-cyan-500 rounded-xl font-bold text-white transition-all">RE-ENTRY</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, getDocs, onSnapshot, collection, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- QUESTIONS ---
        const QUESTIONS_DB = {
            Math: [
                { q: "What is 12 x 12?", a: ["122", "144", "164", "148"], c: 1 },
                { q: "Square root of 81?", a: ["7", "8", "9", "10"], c: 2 },
                { q: "What is 75% of 80?", a: ["50", "60", "65", "70"], c: 1 },
                { q: "Solve for x: 5x = 125", a: ["20", "25", "30", "15"], c: 1 },
                { q: "Angles in a triangle sum to?", a: ["90째", "180째", "270째", "360째"], c: 1 },
                { q: "Prime number between 20 and 25?", a: ["21", "22", "23", "24"], c: 2 },
                { q: "What is 2 to the power of 8?", a: ["128", "256", "512", "64"], c: 1 },
                { q: "3.14 x 100?", a: ["0.314", "31.4", "314", "3140"], c: 2 },
                { q: "Hexagon has how many sides?", a: ["5", "6", "7", "8"], c: 1 },
                { q: "What is 1000 - 333?", a: ["666", "667", "767", "567"], c: 1 }
            ],
            Science: [
                { q: "H2O is the formula for?", a: ["Hydrogen", "Helium", "Water", "Oxygen"], c: 2 },
                { q: "Planet closest to the Sun?", a: ["Venus", "Mars", "Mercury", "Earth"], c: 2 },
                { q: "Gas we breathe in?", a: ["Nitrogen", "Oxygen", "CO2", "Argon"], c: 1 },
                { q: "Au on periodic table?", a: ["Silver", "Gold", "Iron", "Copper"], c: 1 },
                { q: "Powerhouse of the cell?", a: ["Nucleus", "Ribosome", "Mitochondria", "Lysosome"], c: 2 },
                { q: "Speed of sound is faster in...?", a: ["Air", "Water", "Steel", "Vacuum"], c: 2 },
                { q: "Closest star to Earth?", a: ["Sirius", "Proxima Centauri", "Polaris", "The Sun"], c: 3 },
                { q: "Freezing point of water (C)?", a: ["-10", "0", "10", "32"], c: 1 },
                { q: "Largest planet in solar system?", a: ["Saturn", "Jupiter", "Neptune", "Uranus"], c: 1 },
                { q: "Newton's 1st Law is about...?", a: ["Gravity", "Inertia", "Action", "Energy"], c: 1 }
            ],
            History: [
                { q: "First man on the moon?", a: ["Aldrin", "Gagarin", "Armstrong", "Glenn"], c: 2 },
                { q: "Year of US Independence?", a: ["1774", "1775", "1776", "1777"], c: 2 },
                { q: "Who built the Pyramids?", a: ["Romans", "Egyptians", "Greeks", "Mayans"], c: 1 },
                { q: "Magna Carta signed in?", a: ["1215", "1315", "1415", "1515"], c: 0 },
                { q: "Empire of Julius Caesar?", a: ["British", "Holy Roman", "Roman", "Persian"], c: 2 },
                { q: "WW2 ended in?", a: ["1944", "1945", "1946", "1950"], c: 1 },
                { q: "First President of USA?", a: ["Jefferson", "Washington", "Adams", "Lincoln"], c: 1 },
                { q: "Where was Titanic built?", a: ["London", "Belfast", "New York", "Paris"], c: 1 },
                { q: "The 'Great Wall' is in?", a: ["Japan", "China", "India", "Russia"], c: 1 },
                { q: "Ancient city in Peru?", a: ["Petra", "Machu Picchu", "Troy", "Giza"], c: 1 }
            ],
            Literature: [
                { q: "Who wrote Hamlet?", a: ["Dickens", "Shakespeare", "Twain", "Homer"], c: 1 },
                { q: "Sherlock's sidekick?", a: ["Wilson", "Watson", "Walker", "Wayne"], c: 1 },
                { q: "Moby Dick is a...?", a: ["Whale", "Shark", "Squid", "Ship"], c: 0 },
                { q: "Author of 1984?", a: ["Huxley", "Orwell", "Bradbury", "Kafka"], c: 1 },
                { q: "Who wrote Frankenstein?", a: ["Austen", "Bronte", "Shelley", "Eliot"], c: 2 },
                { q: "Bilbo is from what book?", a: ["Narnia", "Harry Potter", "The Hobbit", "Dune"], c: 2 },
                { q: "Poet of 'The Raven'?", a: ["Frost", "Poe", "Keats", "Yeats"], c: 1 },
                { q: "The 'Great Gatsby' setting?", a: ["NY", "Chicago", "Paris", "London"], c: 0 },
                { q: "Author of Pride & Prejudice?", a: ["Austen", "Woolf", "Morrison", "Plath"], c: 0 },
                { q: "Detective Hercule...?", a: ["Holmes", "Poirot", "Marple", "Dresden"], c: 1 }
            ],
            'Pop Culture': [
                { q: "Han Solo's ship?", a: ["Enterprise", "Serenity", "Falcon", "TIE"], c: 2 },
                { q: "Color of Pac-Man?", a: ["Red", "Blue", "Yellow", "Orange"], c: 2 },
                { q: "MCU Iron Man actor?", a: ["Evans", "Downey Jr", "Hemsworth", "Pratt"], c: 1 },
                { q: "The 'Queen of Pop'?", a: ["Beyonce", "Lady Gaga", "Madonna", "Rihanna"], c: 2 },
                { q: "Highest grossing movie?", a: ["Endgame", "Avatar", "Titanic", "Star Wars"], c: 1 },
                { q: "Batman's real name?", a: ["Wayne", "Kent", "Parker", "Stark"], c: 0 },
                { q: "Pac-Man ghosts number?", a: ["3", "4", "5", "6"], c: 1 },
                { q: "Mario's brother?", a: ["Wario", "Luigi", "Yoshi", "Bowser"], c: 1 },
                { q: "Which band sang 'Help!'?", a: ["Stones", "Zeppelin", "Beatles", "Queen"], c: 2 },
                { q: "Pikachu's element?", a: ["Fire", "Water", "Electric", "Grass"], c: 2 }
            ]
        };

        // --- FIREBASE CONFIG ---
        const appId = 'global-nebula-classroom-v1'; // FIXED ID for classroom sync
        let db, auth;

        async function withRetry(fn, retries = 5) {
            for (let i = 0; i < retries; i++) {
                try { return await fn(); } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
        }

        // --- STATE ---
        let user = null;
        let selectedSubject = 'Math';
        let myData = { uid: '', tag: 'ACE', color: '#3b82f6', progress: 0, qIdx: 0, finished: false, time: null };
        let gameState = { status: 'lobby', subject: 'Math', questions: [], lastRacerCountdown: null };
        let activeQuestions = [];
        let startTime = null;
        let raceClock = null;

        const getPublicDataDoc = (coll, id) => doc(db, 'artifacts', appId, 'public', 'data', coll, id);
        const getPublicDataColl = (coll) => collection(db, 'artifacts', appId, 'public', 'data', coll);

        window.selectSubject = (s) => {
            selectedSubject = s;
            document.querySelectorAll('.subject-card').forEach(c => {
                c.classList.remove('selected');
                if (c.dataset.subj === s) c.classList.add('selected');
            });
        };

        const init = async () => {
            // Wait for configuration to be available
            const checkConfig = setInterval(async () => {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    clearInterval(checkConfig);
                    const config = JSON.parse(__firebase_config);
                    const app = initializeApp(config);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    try {
                        await withRetry(async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        });
                        
                        onAuthStateChanged(auth, u => {
                            if (u) {
                                user = u;
                                myData.uid = u.uid;
                                document.getElementById('connection-overlay').style.display = 'none';
                                setupListeners();
                            }
                        });
                    } catch (e) {
                        console.error("Auth failed", e);
                    }
                }
            }, 500);
        };

        const setupListeners = () => {
            // Game State
            onSnapshot(getPublicDataDoc('sessions', 'game'), (snap) => {
                if (!snap.exists()) {
                    if (myData.isHost) resetGameData(); // Initial seed
                    return;
                }
                const data = snap.data();
                const prevStatus = gameState.status;
                gameState = data;
                activeQuestions = gameState.questions;
                
                if (prevStatus === 'lobby' && gameState.status === 'racing') startRace();
                if (gameState.lastRacerCountdown) handleFinalCountdown();
                if (gameState.status === 'finished') showFinalResults();
            }, (err) => {});

            // Players
            onSnapshot(getPublicDataColl('players'), (snap) => {
                const players = [];
                snap.forEach(d => players.push(d.data()));
                updateLobby(players);
                if (gameState.status === 'racing') updateTrack(players);
                
                // Host logic for 30s timer
                if (gameState.status === 'racing' && myData.isHost) {
                    const finishers = players.filter(p => p.finished).length;
                    if (finishers > 0 && players.length > 1 && !gameState.lastRacerCountdown) {
                        updateDoc(getPublicDataDoc('sessions', 'game'), { 
                            lastRacerCountdown: Date.now() + 30000 
                        });
                    }
                }
            }, (err) => {});

            // Leaderboard
            onSnapshot(getPublicDataColl('leaderboard'), (snap) => {
                const list = [];
                snap.forEach(d => list.push(d.data()));
                const sorted = list.sort((a,b) => parseTime(a.time) - parseTime(b.time)).slice(0, 10);
                const container = document.getElementById('global-leaderboard');
                container.innerHTML = sorted.map((r, i) => `
                    <div class="flex justify-between p-2 glass rounded-lg border-l-2" style="border-color: ${r.color}">
                        <span class="font-bold text-slate-300">#${i+1} ${r.tag}</span>
                        <div class="flex gap-4">
                            <span class="text-xs text-slate-500 uppercase">${r.subject}</span>
                            <span class="font-mono text-cyan-400 font-bold">${r.time}</span>
                        </div>
                    </div>
                `).join('') || '<p class="text-slate-500 text-sm italic text-center p-4">HALL OF FAME EMPTY.<br>AWAITING FIRST CHAMPION.</p>';
            }, (err) => {});
        };

        const resetGameData = async () => {
            if (!user) return;
            await setDoc(getPublicDataDoc('sessions', 'game'), {
                status: 'lobby',
                subject: 'Math',
                questions: [],
                lastRacerCountdown: null
            });
        };

        const updateLobby = (players) => {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => `
                <div class="glass px-4 py-2 rounded-xl border-l-4" style="border-color: ${p.color}">
                    <span class="font-bold">PILOT ${p.tag}</span>
                </div>
            `).join('');

            const sorted = players.sort((a,b) => (a.joinedAt || 0) - (b.joinedAt || 0));
            if (sorted[0]?.uid === user.uid) {
                myData.isHost = true;
                document.getElementById('host-controls').classList.remove('hidden');
                document.getElementById('guest-wait').classList.add('hidden');
            } else {
                myData.isHost = false;
                document.getElementById('host-controls').classList.add('hidden');
                document.getElementById('guest-wait').classList.remove('hidden');
            }
        };

        const updateTrack = (players) => {
            const track = document.getElementById('track');
            if (track.children.length !== players.length + 1) {
                track.innerHTML = '<div class="finish-line"></div>';
                players.sort((a,b) => a.uid.localeCompare(b.uid)).forEach(p => {
                    const lane = document.createElement('div');
                    lane.className = 'track-lane';
                    lane.id = `lane-${p.uid}`;
                    track.appendChild(lane);
                });
            }

            players.forEach(p => {
                const lane = document.getElementById(`lane-${p.uid}`);
                if (!lane) return;
                let ship = lane.querySelector('.ship');
                if (!ship) {
                    ship = document.createElement('div');
                    ship.className = 'ship absolute';
                    lane.appendChild(ship);
                }
                
                const finalPos = p.finished ? 89 : (p.progress / 100) * 80;
                ship.style.left = `calc(${finalPos}% + 10px)`;
                ship.style.setProperty('--glow', p.color);
                
                const glow = p.finished ? 'finished-glow' : '';
                const fill = p.finished ? '#22c55e' : p.color;

                ship.innerHTML = `
                    <div class="flex items-center gap-2 ${glow}">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="${fill}" style="transform: rotate(90deg)">
                            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z"/>
                        </svg>
                        <div class="flex flex-col">
                            <span class="text-[9px] font-bold" style="color: ${p.color}">${p.tag}</span>
                            ${p.time ? `<span class="text-[8px] font-mono text-green-400 font-bold">${p.time}</span>` : ''}
                        </div>
                    </div>
                `;
            });
        };

        const startRace = () => {
            document.getElementById('screen-lobby').classList.add('hidden');
            document.getElementById('screen-race').classList.remove('hidden');
            document.getElementById('race-subject-label').innerText = gameState.subject;
            startTime = Date.now();
            raceClock = setInterval(() => {
                if (myData.finished) return;
                const diff = Date.now() - startTime;
                document.getElementById('timer-text').innerText = formatMillis(diff);
            }, 50);
            loadQuestion();
        };

        const loadQuestion = () => {
            if (myData.finished) return;
            const q = activeQuestions[myData.qIdx];
            document.getElementById('question-count').innerText = `${myData.qIdx + 1} / 10`;
            document.getElementById('question-text').innerText = q.q;
            
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'p-4 glass rounded-xl hover:bg-slate-700 transition-all text-left font-mono text-sm border border-slate-700 text-white';
                btn.innerText = opt;
                btn.onclick = () => submitAnswer(i);
                grid.appendChild(btn);
            });
        };

        const submitAnswer = async (idx) => {
            if (!user) return;
            const q = activeQuestions[myData.qIdx];
            if (idx === q.c) {
                myData.qIdx++;
                myData.progress = (myData.qIdx / 10) * 100;
                if (myData.qIdx >= 10) {
                    myData.finished = true;
                    myData.time = document.getElementById('timer-text').innerText;
                    await addDoc(getPublicDataColl('leaderboard'), {
                        tag: myData.tag,
                        time: myData.time,
                        subject: gameState.subject,
                        color: myData.color,
                        timestamp: Date.now()
                    });
                }
                await updateDoc(getPublicDataDoc('players', user.uid), {
                    progress: myData.progress,
                    qIdx: myData.qIdx,
                    finished: myData.finished,
                    time: myData.time
                });
                if (myData.finished) {
                    document.getElementById('quiz-ui').innerHTML = `<div class="text-center py-4"><h2 class="text-2xl font-bold text-green-400 uppercase">MISSION SUCCESS</h2><p class="font-mono mt-2 text-white">${myData.time}</p></div>`;
                } else {
                    loadQuestion();
                }
            } else {
                document.getElementById('penalty-ui').classList.remove('hidden');
                let count = 5.0;
                const interval = setInterval(() => {
                    count -= 0.1;
                    document.querySelector('#penalty-ui p').innerText = `Recalibrating... ${count.toFixed(1)}s`;
                    if (count <= 0) {
                        clearInterval(interval);
                        document.getElementById('penalty-ui').classList.add('hidden');
                    }
                }, 100);
            }
        };

        const formatMillis = (ms) => {
            const m = Math.floor(ms / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            const mil = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
            return `${m}:${s}.${mil}`;
        };

        const parseTime = (t) => {
            if (!t) return 999999;
            const parts = t.split(/[:.]/);
            return (parseInt(parts[0])*60) + parseInt(parts[1]) + (parseInt(parts[2])/100);
        };

        const handleFinalCountdown = () => {
            const container = document.getElementById('final-timer-container');
            container.classList.remove('hidden');
            const timer = document.getElementById('final-timer');
            const update = () => {
                const diff = gameState.lastRacerCountdown - Date.now();
                if (diff <= 0) {
                    timer.innerText = "0s";
                    if (myData.isHost) updateDoc(getPublicDataDoc('sessions', 'game'), { status: 'finished' });
                    return;
                }
                timer.innerText = Math.ceil(diff / 1000) + 's';
                requestAnimationFrame(update);
            };
            update();
        };

        const showFinalResults = async () => {
            clearInterval(raceClock);
            document.getElementById('screen-race').classList.add('hidden');
            document.getElementById('screen-results').classList.remove('hidden');
            const snap = await getDocs(getPublicDataColl('players'));
            const players = [];
            snap.forEach(d => players.push(d.data()));
            const sorted = players.sort((a,b) => {
                if (a.finished && !b.finished) return -1;
                if (!a.finished && b.finished) return 1;
                if (a.finished && b.finished) return parseTime(a.time) - parseTime(b.time);
                return b.progress - a.progress;
            });
            document.getElementById('rankings').innerHTML = sorted.map((p, i) => `
                <div class="glass p-4 rounded-xl flex justify-between items-center border-l-4" style="border-color: ${p.color}">
                    <span class="font-bold">#${i+1} ${p.tag}</span>
                    <span class="font-mono text-cyan-400 font-bold">${p.time || 'DNF'}</span>
                </div>
            `).join('');
        };

        // --- BUTTONS ---
        document.getElementById('btn-join').onclick = async () => {
            if (!user) return;
            myData.tag = document.getElementById('player-tag').value.toUpperCase().slice(0,3) || 'ACE';
            myData.color = document.getElementById('player-color').value;
            await setDoc(getPublicDataDoc('players', user.uid), {
                ...myData,
                joinedAt: Date.now()
            });
            document.getElementById('setup-controls').classList.add('hidden');
            document.getElementById('lobby-wait').classList.remove('hidden');
        };

        document.getElementById('btn-start').onclick = async () => {
            if (!user) return;
            const qPool = QUESTIONS_DB[selectedSubject].sort(() => Math.random() - 0.5);
            await setDoc(getPublicDataDoc('sessions', 'game'), {
                status: 'racing',
                subject: selectedSubject,
                questions: qPool,
                lastRacerCountdown: null
            });
        };

        document.getElementById('btn-reset').onclick = async () => {
            if (!user || !confirm("Clear all racers and reset the classroom?")) return;
            const snap = await getDocs(getPublicDataColl('players'));
            const deletions = [];
            snap.forEach(d => deletions.push(deleteDoc(getPublicDataDoc('players', d.id))));
            await Promise.all(deletions);
            await resetGameData();
            location.reload();
        };

        // Subjects
        document.querySelectorAll('.subject-card').forEach(card => {
            card.addEventListener('click', () => window.selectSubject(card.dataset.subj));
        });

        // Initialize
        window.onload = init;

        // Background
        const starsBox = document.getElementById('stars');
        for (let i = 0; i < 150; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.left = Math.random() * 100 + '%';
            s.style.top = Math.random() * 100 + '%';
            s.style.width = s.style.height = (Math.random() * 2 + 1) + 'px';
            s.style.setProperty('--duration', (2 + Math.random() * 4) + 's');
            starsBox.appendChild(s);
        }
    </script>
</body>
</html>
