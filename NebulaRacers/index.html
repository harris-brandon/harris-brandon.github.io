<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula Racers: Classroom Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            background: #020617;
            color: #f8fafc;
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        .space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: twinkle var(--duration) infinite ease-in-out;
        }

        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .ship {
            transition: left 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(0 0 10px var(--glow));
            display: flex;
            align-items: center;
            height: 100%;
            top: 0;
            pointer-events: none;
        }

        .track-lane {
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 70px;
            width: 100%;
        }

        .finish-line {
            background: repeating-conic-gradient(#fff 0% 25%, #000 0% 50%) 50% / 15px 15px;
            width: 40px;
            height: 100%;
            position: absolute;
            right: 120px;
            opacity: 0.4;
            border-left: 2px solid white;
            z-index: 5;
        }

        .glass {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .subject-card {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .subject-card.selected {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
            transform: scale(1.05);
        }

        .finished-glow {
            filter: drop-shadow(0 0 20px #22c55e) !important;
        }

        .invite-link {
            background: rgba(6, 182, 212, 0.1);
            border: 1px dashed #06b6d4;
            cursor: pointer;
            transition: all 0.2s;
        }
        .invite-link:hover {
            background: rgba(6, 182, 212, 0.2);
        }

        .answer-option {
            cursor: pointer;
            transition: all 0.2s;
        }
        .answer-option.correct {
            border-color: #22c55e !important;
            background: rgba(34, 197, 94, 0.2);
        }
        .answer-option:hover {
            background: rgba(255,255,255,0.05);
        }

        .question-item {
            border-left: 3px solid #6366f1;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        .spectator-badge {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.8); }
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 250px;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .chat-message {
            padding: 6px 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            font-size: 12px;
        }
        .chat-message.own {
            background: rgba(6, 182, 212, 0.2);
            align-self: flex-end;
        }
        .chat-message .author {
            font-weight: bold;
            font-size: 10px;
            margin-bottom: 2px;
        }
        .chat-message.system {
            background: rgba(139, 92, 246, 0.2);
            text-align: center;
            font-style: italic;
            color: #a78bfa;
        }
        .qr-container {
            background: white;
            padding: 12px;
            border-radius: 12px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen w-screen flex flex-col">
        <div class="space-bg" id="stars"></div>

        <!-- Connection Overlay -->
        <div id="connection-overlay" class="fixed inset-0 bg-slate-950 z-[100] flex flex-col items-center justify-center">
            <div id="loader-icon" class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-500 mb-4"></div>
            <p id="connection-status" class="text-cyan-500 font-mono tracking-widest animate-pulse">ESTABLISHING LINK...</p>
            <button id="retry-btn" onclick="location.reload()" class="hidden mt-6 px-6 py-2 border border-cyan-500 text-cyan-500 rounded-lg hover:bg-cyan-500/10">RETRY CONNECTION</button>
        </div>

        <!-- Home Screen - Host or Join -->
        <div id="screen-home" class="hidden flex-grow flex flex-col items-center justify-center p-4">
            <div class="glass p-8 rounded-3xl w-full max-w-md text-center shadow-2xl">
                <h1 class="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 uppercase">Nebula Racers</h1>
                <p class="text-slate-400 text-sm mb-8">Classroom Quiz Racing</p>

                <div class="space-y-4">
                    <button id="btn-host" class="w-full py-4 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold text-xl transition-all shadow-lg text-white uppercase">
                        Host a Game
                    </button>

                    <div class="flex items-center gap-4 my-6">
                        <div class="flex-grow h-px bg-slate-700"></div>
                        <span class="text-slate-500 text-xs uppercase">or</span>
                        <div class="flex-grow h-px bg-slate-700"></div>
                    </div>

                    <div class="space-y-3">
                        <input type="text" id="join-code" maxlength="6" placeholder="ENTER CODE" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl font-mono text-center uppercase text-white text-xl tracking-widest outline-none focus:border-cyan-500">
                        <button id="btn-join-code" class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 rounded-xl font-bold text-xl transition-all shadow-lg text-white uppercase">
                            Join Game
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Host Setup Screen -->
        <div id="screen-host-setup" class="hidden flex-grow flex flex-col items-center justify-center p-4 overflow-y-auto">
            <div class="glass p-8 rounded-3xl w-full max-w-4xl shadow-2xl my-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 uppercase">Create Your Quiz</h1>
                        <p class="text-slate-400 text-xs mt-1">You'll spectate while students race</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 uppercase">Room Code</p>
                        <p id="host-room-code" class="font-mono text-2xl text-cyan-400 font-bold"></p>
                    </div>
                </div>

                <!-- Invite Link & QR Code -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Share this link with your class:</p>
                        <div id="host-invite-link" class="invite-link p-3 rounded-xl font-mono text-sm text-cyan-400 break-all" onclick="copyInviteLink()"></div>
                        <p id="host-copy-feedback" class="text-xs text-green-400 mt-1 hidden">Copied to clipboard!</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Scan to Join</p>
                        <div class="qr-container inline-block">
                            <canvas id="host-qr-code"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Quiz Type Toggle -->
                <div class="flex gap-4 mb-6">
                    <button id="btn-preset-quiz" onclick="setQuizMode('preset')" class="flex-1 py-3 bg-purple-600 rounded-xl font-bold text-sm transition-all text-white uppercase">
                        Use Preset Subject
                    </button>
                    <button id="btn-custom-quiz" onclick="setQuizMode('custom')" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm transition-all text-white uppercase">
                        Create Custom Quiz
                    </button>
                </div>

                <!-- Preset Subject Selection -->
                <div id="preset-quiz-section">
                    <div class="space-y-3 mb-6">
                        <label class="text-[10px] text-slate-400 uppercase font-bold">Select Subject</label>
                        <div id="host-subject-list" class="grid grid-cols-3 md:grid-cols-5 gap-2">
                            <div class="subject-card glass p-3 rounded-lg text-xs text-center selected" onclick="selectSubject('Math')" data-subj="Math">Math</div>
                            <div class="subject-card glass p-3 rounded-lg text-xs text-center" onclick="selectSubject('Science')" data-subj="Science">Science</div>
                            <div class="subject-card glass p-3 rounded-lg text-xs text-center" onclick="selectSubject('History')" data-subj="History">History</div>
                            <div class="subject-card glass p-3 rounded-lg text-xs text-center" onclick="selectSubject('Literature')" data-subj="Literature">Literature</div>
                            <div class="subject-card glass p-3 rounded-lg text-xs text-center" onclick="selectSubject('Pop Culture')" data-subj="Pop Culture">Pop Culture</div>
                        </div>
                    </div>
                </div>

                <!-- Custom Quiz Builder -->
                <div id="custom-quiz-section" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Question Form -->
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold">Quiz Title</label>
                                <input type="text" id="custom-quiz-title" placeholder="My Custom Quiz" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-cyan-500 mt-1">
                            </div>

                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold">Question</label>
                                <input type="text" id="custom-question" placeholder="Enter your question..." class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-cyan-500 mt-1">
                            </div>

                            <div class="space-y-2">
                                <label class="text-[10px] text-slate-400 uppercase font-bold">Answers (click to mark correct)</label>
                                <div id="custom-answers" class="space-y-2">
                                    <input type="text" data-idx="0" placeholder="Answer 1" class="answer-input w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-cyan-500 answer-option" onclick="markCorrect(0)">
                                    <input type="text" data-idx="1" placeholder="Answer 2" class="answer-input w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-cyan-500 answer-option" onclick="markCorrect(1)">
                                    <input type="text" data-idx="2" placeholder="Answer 3" class="answer-input w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-cyan-500 answer-option" onclick="markCorrect(2)">
                                    <input type="text" data-idx="3" placeholder="Answer 4" class="answer-input w-full bg-slate-900 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-cyan-500 answer-option" onclick="markCorrect(3)">
                                </div>
                                <p class="text-[10px] text-slate-500">Click an answer field to mark it as correct (green border)</p>
                            </div>

                            <button onclick="addCustomQuestion()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-sm text-white uppercase">
                                + Add Question
                            </button>
                        </div>

                        <!-- Question List -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] text-slate-400 uppercase font-bold">Questions Added</label>
                                <span id="question-count-label" class="text-xs text-cyan-400 font-mono">0 / 10 minimum</span>
                            </div>
                            <div id="custom-questions-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                                <p class="text-slate-500 text-sm italic text-center py-8">No questions yet. Add at least 10!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Connected Players & Chat -->
                <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-cyan-500/10 border border-cyan-500/20 p-4 rounded-xl">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] text-cyan-400 font-bold uppercase">Connected Pilots</p>
                            <span id="host-player-count" class="text-xs text-cyan-400 font-mono">0 players</span>
                        </div>
                        <div id="host-player-list" class="flex flex-wrap gap-2 min-h-[40px]">
                            <p class="text-slate-500 text-xs italic">Waiting for players to join...</p>
                        </div>
                    </div>

                    <!-- Chat -->
                    <div class="glass border border-slate-700 rounded-xl overflow-hidden chat-container">
                        <div class="bg-slate-800/50 px-3 py-2 border-b border-slate-700">
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Lobby Chat</p>
                        </div>
                        <div id="host-chat-messages" class="chat-messages custom-scrollbar">
                            <div class="chat-message system">Welcome to the lobby!</div>
                        </div>
                        <div class="p-2 border-t border-slate-700 flex gap-2">
                            <input type="text" id="host-chat-input" placeholder="Type a message..." maxlength="200" class="flex-1 bg-slate-900 border border-slate-700 px-3 py-2 rounded-lg text-sm text-white outline-none focus:border-cyan-500">
                            <button onclick="sendChat('host')" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-xs font-bold text-white">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Launch Button -->
                <div class="mt-6 flex gap-4">
                    <button id="btn-launch" class="flex-1 py-4 bg-green-600 hover:bg-green-500 rounded-xl font-bold text-xl text-white shadow-xl uppercase disabled:opacity-50 disabled:cursor-not-allowed">
                        Launch Race
                    </button>
                    <button onclick="goHome()" class="px-6 py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm text-white uppercase">
                        Cancel
                    </button>
                </div>
                <p id="launch-warning" class="text-xs text-yellow-400 mt-2 text-center hidden">Need at least 1 player and 10 questions to launch!</p>
            </div>
        </div>

        <!-- Player Lobby Screen -->
        <div id="screen-lobby" class="hidden flex-grow flex flex-col items-center justify-center p-4">
            <div class="glass p-8 rounded-3xl w-full max-w-2xl text-center shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 uppercase">Nebula Racers</h1>
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 uppercase">Room Code</p>
                        <p id="room-code-display" class="font-mono text-2xl text-cyan-400 font-bold"></p>
                    </div>
                </div>

                <div id="player-setup-controls" class="space-y-6 text-left">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-[10px] text-slate-400 uppercase font-bold">Pilot Tag (3 Char)</label>
                            <input type="text" id="player-tag" maxlength="3" value="ACE" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl font-mono text-center uppercase text-white outline-none focus:border-cyan-500">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] text-slate-400 uppercase font-bold">Hull Color</label>
                            <input type="color" id="player-color" value="#3b82f6" class="w-full h-12 bg-slate-900 border border-slate-700 rounded-xl cursor-pointer">
                        </div>
                    </div>

                    <button id="btn-join-race" class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 rounded-xl font-bold text-xl transition-all shadow-lg text-white uppercase">Enter Hangar</button>
                </div>

                <div id="player-lobby-wait" class="hidden mt-8 space-y-4">
                    <div class="bg-cyan-500/10 border border-cyan-500/20 p-4 rounded-xl text-left">
                        <p class="text-[10px] text-cyan-400 font-bold uppercase mb-2">Connected Pilots</p>
                        <div id="player-list" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Player Chat -->
                    <div class="glass border border-slate-700 rounded-xl overflow-hidden chat-container text-left">
                        <div class="bg-slate-800/50 px-3 py-2 border-b border-slate-700">
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Lobby Chat</p>
                        </div>
                        <div id="player-chat-messages" class="chat-messages custom-scrollbar">
                            <div class="chat-message system">Welcome to the lobby!</div>
                        </div>
                        <div class="p-2 border-t border-slate-700 flex gap-2">
                            <input type="text" id="player-chat-input" placeholder="Type a message..." maxlength="200" class="flex-1 bg-slate-900 border border-slate-700 px-3 py-2 rounded-lg text-sm text-white outline-none focus:border-cyan-500">
                            <button onclick="sendChat('player')" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-xs font-bold text-white">Send</button>
                        </div>
                    </div>

                    <p class="animate-pulse text-cyan-400 font-mono italic text-center">Awaiting Host to Launch Race...</p>
                </div>
            </div>
        </div>

        <!-- Race Screen -->
        <div id="screen-race" class="hidden flex-grow flex flex-col overflow-hidden">
            <div class="glass p-4 flex justify-between items-center border-b border-slate-800">
                <div class="flex items-center gap-6">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-500 uppercase font-bold">Progress</span>
                        <span id="question-count" class="font-mono text-xl text-cyan-400">1 / 10</span>
                    </div>
                    <div id="spectator-indicator" class="hidden spectator-badge px-4 py-2 rounded-xl">
                        <span class="text-white text-xs font-bold uppercase">Spectator Mode</span>
                    </div>
                    <div id="final-timer-container" class="hidden flex items-center gap-3 px-4 py-2 bg-red-900/30 border border-red-500/50 rounded-xl">
                        <span class="text-red-500 text-xs font-bold animate-pulse">CLEANUP:</span>
                        <span id="final-timer" class="font-mono text-2xl text-white">30s</span>
                    </div>
                </div>
                <div class="text-right flex items-center gap-4">
                    <div>
                        <p id="race-subject-label" class="text-xs text-slate-400 font-bold uppercase"></p>
                        <p id="timer-text" class="font-mono text-lg text-slate-300">00:00.00</p>
                    </div>
                    <button id="btn-end-race" class="hidden px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-xs font-bold text-white uppercase">End Race</button>
                </div>
            </div>

            <div class="flex-grow relative bg-slate-950 flex flex-col overflow-hidden" id="track">
                <!-- Lanes injected here -->
            </div>

            <div id="quiz-ui" class="absolute bottom-6 left-1/2 -translate-x-1/2 w-full max-w-2xl glass p-8 rounded-3xl shadow-2xl z-50">
                <h3 id="question-text" class="text-lg md:text-xl font-bold mb-6 text-center h-16"></h3>
                <div id="options-grid" class="grid grid-cols-2 gap-4"></div>
            </div>

            <div id="penalty-ui" class="hidden absolute inset-0 bg-red-950/80 backdrop-blur-md flex flex-col items-center justify-center z-[60]">
                <h2 class="text-5xl font-bold text-red-500 mb-2 italic">ENGINE STALL</h2>
                <p class="font-mono text-white text-xl">Recalibrating... 5.0s</p>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="screen-results" class="hidden flex-grow flex flex-col items-center justify-center p-4">
            <div class="glass p-10 rounded-3xl w-full max-w-2xl text-center shadow-2xl">
                <h1 class="text-4xl font-bold mb-8 text-yellow-400">MISSION DEBRIEF</h1>
                <div id="rankings" class="space-y-4 mb-8"></div>

                <!-- Host controls -->
                <div id="results-host-controls" class="hidden space-y-3">
                    <button onclick="playAgain()" class="w-full px-10 py-4 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold text-white transition-all uppercase">Play Again</button>
                    <button onclick="goHome()" class="w-full px-10 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm text-white transition-all uppercase">End Session</button>
                </div>

                <!-- Player waiting -->
                <div id="results-player-wait" class="hidden">
                    <p class="animate-pulse text-cyan-400 font-mono italic mb-4">Waiting for host to start next race...</p>
                    <button onclick="goHome()" class="px-10 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm text-white transition-all uppercase">Leave Session</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, getDocs, onSnapshot, collection, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const QUESTIONS_DB = {
            Math: [
                { q: "What is 12 x 12?", a: ["122", "144", "164", "148"], c: 1 },
                { q: "Square root of 81?", a: ["7", "8", "9", "10"], c: 2 },
                { q: "What is 75% of 80?", a: ["50", "60", "65", "70"], c: 1 },
                { q: "Solve for x: 5x = 125", a: ["20", "25", "30", "15"], c: 1 },
                { q: "Angles in a triangle sum to?", a: ["90°", "180°", "270°", "360°"], c: 1 },
                { q: "Prime number between 20 and 25?", a: ["21", "22", "23", "24"], c: 2 },
                { q: "What is 2 to the power of 8?", a: ["128", "256", "512", "64"], c: 1 },
                { q: "3.14 x 100?", a: ["0.314", "31.4", "314", "3140"], c: 2 },
                { q: "Hexagon has how many sides?", a: ["5", "6", "7", "8"], c: 1 },
                { q: "What is 1000 - 333?", a: ["666", "667", "767", "567"], c: 1 },
                { q: "What is 15 x 15?", a: ["215", "225", "235", "245"], c: 1 },
                { q: "Square root of 144?", a: ["10", "11", "12", "13"], c: 2 },
                { q: "What is 20% of 500?", a: ["50", "100", "150", "200"], c: 1 },
                { q: "Solve: 3x + 7 = 22", a: ["3", "4", "5", "6"], c: 2 },
                { q: "How many degrees in a circle?", a: ["180°", "270°", "360°", "400°"], c: 2 },
                { q: "What is 7 factorial (7!)?", a: ["720", "5040", "2520", "40320"], c: 1 },
                { q: "Cube root of 27?", a: ["2", "3", "4", "9"], c: 1 },
                { q: "What is 0.5 as a fraction?", a: ["1/3", "1/4", "1/2", "2/3"], c: 2 },
                { q: "Area of a square with side 9?", a: ["18", "72", "81", "90"], c: 2 },
                { q: "What is 17 + 38?", a: ["45", "55", "65", "75"], c: 1 },
                { q: "What is 256 ÷ 16?", a: ["14", "15", "16", "17"], c: 2 },
                { q: "Perimeter of rectangle 5x3?", a: ["8", "15", "16", "30"], c: 2 },
                { q: "What is 11 squared?", a: ["111", "121", "131", "141"], c: 1 },
                { q: "GCD of 24 and 36?", a: ["6", "8", "12", "18"], c: 2 },
                { q: "What is 1/4 + 1/2?", a: ["1/6", "2/6", "3/4", "1/3"], c: 2 },
                { q: "How many cm in a meter?", a: ["10", "100", "1000", "10000"], c: 1 },
                { q: "What is 9 x 7?", a: ["56", "63", "72", "81"], c: 1 },
                { q: "Value of Pi to 2 decimals?", a: ["3.12", "3.14", "3.16", "3.18"], c: 1 },
                { q: "What is 50% of 250?", a: ["100", "125", "150", "175"], c: 1 },
                { q: "Octagon has how many sides?", a: ["6", "7", "8", "9"], c: 2 },
                { q: "What is 2³?", a: ["4", "6", "8", "16"], c: 2 },
                { q: "LCM of 4 and 6?", a: ["8", "10", "12", "24"], c: 2 },
                { q: "What is 999 + 1?", a: ["1000", "9991", "1001", "990"], c: 0 },
                { q: "Radius if diameter is 10?", a: ["2", "5", "10", "20"], c: 1 },
                { q: "What is 45 ÷ 9?", a: ["4", "5", "6", "7"], c: 1 },
                { q: "Roman numeral for 50?", a: ["C", "D", "L", "M"], c: 2 },
                { q: "What is 8 x 8?", a: ["56", "64", "72", "80"], c: 1 },
                { q: "Sum of angles in a square?", a: ["180°", "270°", "360°", "540°"], c: 2 },
                { q: "What is 1000 x 0.01?", a: ["1", "10", "100", "0.1"], c: 1 },
                { q: "How many sides has a pentagon?", a: ["4", "5", "6", "7"], c: 1 },
                { q: "What is 13 x 13?", a: ["156", "163", "169", "176"], c: 2 },
                { q: "Square root of 225?", a: ["13", "14", "15", "16"], c: 2 },
                { q: "What is 3/4 as a decimal?", a: ["0.25", "0.5", "0.75", "0.8"], c: 2 },
                { q: "Volume of cube with side 3?", a: ["9", "18", "27", "36"], c: 2 },
                { q: "What is 100 - 37?", a: ["53", "63", "73", "83"], c: 1 },
                { q: "How many mm in a cm?", a: ["1", "10", "100", "1000"], c: 1 },
                { q: "What is 6!?", a: ["120", "360", "720", "5040"], c: 2 },
                { q: "Solve: 2x = 48", a: ["12", "24", "36", "96"], c: 1 },
                { q: "What is 19 + 27?", a: ["36", "46", "56", "66"], c: 1 },
                { q: "Complementary angle to 30°?", a: ["30°", "60°", "90°", "150°"], c: 1 }
            ],
            Science: [
                { q: "H2O is the formula for?", a: ["Hydrogen", "Helium", "Water", "Oxygen"], c: 2 },
                { q: "Planet closest to the Sun?", a: ["Venus", "Mars", "Mercury", "Earth"], c: 2 },
                { q: "Gas we breathe in?", a: ["Nitrogen", "Oxygen", "CO2", "Argon"], c: 1 },
                { q: "Au on periodic table?", a: ["Silver", "Gold", "Iron", "Copper"], c: 1 },
                { q: "Powerhouse of the cell?", a: ["Nucleus", "Ribosome", "Mitochondria", "Lysosome"], c: 2 },
                { q: "Speed of sound is faster in...?", a: ["Air", "Water", "Steel", "Vacuum"], c: 2 },
                { q: "Closest star to Earth?", a: ["Sirius", "Proxima Centauri", "Polaris", "The Sun"], c: 3 },
                { q: "Freezing point of water (C)?", a: ["-10", "0", "10", "32"], c: 1 },
                { q: "Largest planet in solar system?", a: ["Saturn", "Jupiter", "Neptune", "Uranus"], c: 1 },
                { q: "Newton's 1st Law is about...?", a: ["Gravity", "Inertia", "Action", "Energy"], c: 1 },
                { q: "Symbol for Sodium?", a: ["So", "Sd", "Na", "S"], c: 2 },
                { q: "How many bones in adult body?", a: ["186", "206", "226", "246"], c: 1 },
                { q: "What gas do plants absorb?", a: ["Oxygen", "Nitrogen", "CO2", "Helium"], c: 2 },
                { q: "Boiling point of water (C)?", a: ["90", "100", "110", "212"], c: 1 },
                { q: "What is the largest organ?", a: ["Heart", "Liver", "Skin", "Brain"], c: 2 },
                { q: "Fe on the periodic table?", a: ["Fluorine", "Iron", "Fermium", "Francium"], c: 1 },
                { q: "Red planet?", a: ["Venus", "Mars", "Jupiter", "Mercury"], c: 1 },
                { q: "What causes tides?", a: ["Wind", "Sun", "Moon", "Earthquakes"], c: 2 },
                { q: "DNA stands for?", a: ["Deoxyribonucleic Acid", "Dual Nuclear Acid", "Dynamic Nucleic Acid", "Dense Nucleus Acid"], c: 0 },
                { q: "Speed of light (km/s)?", a: ["30,000", "300,000", "3,000,000", "30,000,000"], c: 1 },
                { q: "Smallest unit of matter?", a: ["Cell", "Molecule", "Atom", "Electron"], c: 2 },
                { q: "What type of rock is granite?", a: ["Sedimentary", "Igneous", "Metamorphic", "Mineral"], c: 1 },
                { q: "How many chromosomes in humans?", a: ["23", "46", "48", "64"], c: 1 },
                { q: "What does CPU stand for?", a: ["Central Process Unit", "Central Processing Unit", "Computer Personal Unit", "Central Power Unit"], c: 1 },
                { q: "Largest ocean on Earth?", a: ["Atlantic", "Indian", "Pacific", "Arctic"], c: 2 },
                { q: "What vitamin comes from the Sun?", a: ["A", "B", "C", "D"], c: 3 },
                { q: "Which blood type is universal donor?", a: ["A", "B", "AB", "O"], c: 3 },
                { q: "Hardest natural substance?", a: ["Gold", "Iron", "Diamond", "Titanium"], c: 2 },
                { q: "What is photosynthesis?", a: ["Animal breathing", "Plant making food", "Rock formation", "Water cycle"], c: 1 },
                { q: "What planet has rings?", a: ["Mars", "Jupiter", "Saturn", "Neptune"], c: 2 },
                { q: "How many hearts does an octopus have?", a: ["1", "2", "3", "4"], c: 2 },
                { q: "What causes a rainbow?", a: ["Rain", "Light refraction", "Clouds", "Wind"], c: 1 },
                { q: "Ag on periodic table?", a: ["Gold", "Silver", "Argon", "Aluminum"], c: 1 },
                { q: "Which planet is hottest?", a: ["Mercury", "Venus", "Mars", "Jupiter"], c: 1 },
                { q: "What is H2SO4?", a: ["Water", "Salt", "Sulfuric Acid", "Sugar"], c: 2 },
                { q: "Earth's atmosphere is mostly?", a: ["Oxygen", "Nitrogen", "CO2", "Hydrogen"], c: 1 },
                { q: "What is absolute zero (C)?", a: ["-273", "-100", "0", "-460"], c: 0 },
                { q: "Light year measures?", a: ["Time", "Speed", "Distance", "Brightness"], c: 2 },
                { q: "Main gas in the Sun?", a: ["Oxygen", "Helium", "Hydrogen", "Nitrogen"], c: 2 },
                { q: "What animal is a marsupial?", a: ["Elephant", "Kangaroo", "Lion", "Bear"], c: 1 },
                { q: "How many lungs do humans have?", a: ["1", "2", "3", "4"], c: 1 },
                { q: "What is the study of earthquakes?", a: ["Geology", "Seismology", "Meteorology", "Ecology"], c: 1 },
                { q: "Pb on periodic table?", a: ["Platinum", "Plutonium", "Lead", "Potassium"], c: 2 },
                { q: "Which planet has the most moons?", a: ["Jupiter", "Saturn", "Uranus", "Neptune"], c: 1 },
                { q: "What is NaCl?", a: ["Sugar", "Salt", "Baking soda", "Vinegar"], c: 1 },
                { q: "Electrons have what charge?", a: ["Positive", "Negative", "Neutral", "Variable"], c: 1 },
                { q: "What is the study of weather?", a: ["Geology", "Astronomy", "Meteorology", "Biology"], c: 2 },
                { q: "What organ pumps blood?", a: ["Liver", "Kidney", "Heart", "Lung"], c: 2 },
                { q: "How many planets in our solar system?", a: ["7", "8", "9", "10"], c: 1 },
                { q: "What causes seasons on Earth?", a: ["Distance from Sun", "Earth's tilt", "Moon's gravity", "Solar flares"], c: 1 }
            ],
            History: [
                { q: "First man on the moon?", a: ["Aldrin", "Gagarin", "Armstrong", "Glenn"], c: 2 },
                { q: "Year of US Independence?", a: ["1774", "1775", "1776", "1777"], c: 2 },
                { q: "Who built the Pyramids?", a: ["Romans", "Egyptians", "Greeks", "Mayans"], c: 1 },
                { q: "Magna Carta signed in?", a: ["1215", "1315", "1415", "1515"], c: 0 },
                { q: "Empire of Julius Caesar?", a: ["British", "Holy Roman", "Roman", "Persian"], c: 2 },
                { q: "WW2 ended in?", a: ["1944", "1945", "1946", "1950"], c: 1 },
                { q: "First President of USA?", a: ["Jefferson", "Washington", "Adams", "Lincoln"], c: 1 },
                { q: "Where was Titanic built?", a: ["London", "Belfast", "New York", "Paris"], c: 1 },
                { q: "The 'Great Wall' is in?", a: ["Japan", "China", "India", "Russia"], c: 1 },
                { q: "Ancient city in Peru?", a: ["Petra", "Machu Picchu", "Troy", "Giza"], c: 1 },
                { q: "Who discovered America in 1492?", a: ["Magellan", "Columbus", "Vespucci", "Cortez"], c: 1 },
                { q: "French Revolution started in?", a: ["1776", "1789", "1804", "1815"], c: 1 },
                { q: "Who was Cleopatra?", a: ["Roman empress", "Egyptian queen", "Greek goddess", "Persian princess"], c: 1 },
                { q: "Berlin Wall fell in?", a: ["1985", "1987", "1989", "1991"], c: 2 },
                { q: "Who wrote the Declaration of Independence?", a: ["Washington", "Adams", "Jefferson", "Franklin"], c: 2 },
                { q: "Renaissance began in?", a: ["France", "England", "Italy", "Spain"], c: 2 },
                { q: "Who was the first Roman Emperor?", a: ["Julius Caesar", "Augustus", "Nero", "Caligula"], c: 1 },
                { q: "WW1 started in?", a: ["1912", "1914", "1916", "1918"], c: 1 },
                { q: "Who painted the Mona Lisa?", a: ["Michelangelo", "Da Vinci", "Raphael", "Donatello"], c: 1 },
                { q: "The Cold War was between?", a: ["UK & France", "USA & USSR", "China & Japan", "Germany & Italy"], c: 1 },
                { q: "Ancient Greek city of philosophy?", a: ["Sparta", "Athens", "Troy", "Corinth"], c: 1 },
                { q: "Who was Henry VIII?", a: ["French King", "English King", "Spanish King", "German King"], c: 1 },
                { q: "Pearl Harbor attacked in?", a: ["1939", "1940", "1941", "1942"], c: 2 },
                { q: "Who led India to independence?", a: ["Nehru", "Gandhi", "Patel", "Bose"], c: 1 },
                { q: "The Industrial Revolution began in?", a: ["USA", "France", "Britain", "Germany"], c: 2 },
                { q: "Who was Napoleon?", a: ["French Emperor", "British King", "Russian Czar", "Spanish King"], c: 0 },
                { q: "Civil Rights Act passed in?", a: ["1954", "1960", "1964", "1968"], c: 2 },
                { q: "Ancient wonder: Hanging Gardens of?", a: ["Athens", "Rome", "Babylon", "Egypt"], c: 2 },
                { q: "Who invented the printing press?", a: ["Edison", "Gutenberg", "Franklin", "Newton"], c: 1 },
                { q: "Vietnam War ended in?", a: ["1973", "1975", "1977", "1979"], c: 1 },
                { q: "Who was Alexander the Great?", a: ["Roman General", "Greek Conqueror", "Persian King", "Egyptian Pharaoh"], c: 1 },
                { q: "The Reformation was led by?", a: ["Calvin", "Luther", "Henry VIII", "Pope Leo"], c: 1 },
                { q: "Soviet Union dissolved in?", a: ["1989", "1990", "1991", "1992"], c: 2 },
                { q: "Who was Genghis Khan?", a: ["Chinese Emperor", "Mongol Leader", "Japanese Shogun", "Indian King"], c: 1 },
                { q: "The Crusades were fought for?", a: ["Trade routes", "Holy Land", "Gold", "Spices"], c: 1 },
                { q: "Who was Queen Victoria?", a: ["French Queen", "British Queen", "Spanish Queen", "Russian Empress"], c: 1 },
                { q: "American Civil War ended in?", a: ["1863", "1864", "1865", "1866"], c: 2 },
                { q: "Who discovered penicillin?", a: ["Pasteur", "Fleming", "Curie", "Koch"], c: 1 },
                { q: "The Ottoman Empire was based in?", a: ["Greece", "Turkey", "Egypt", "Iran"], c: 1 },
                { q: "Who was Socrates?", a: ["Roman poet", "Greek philosopher", "Egyptian priest", "Persian scholar"], c: 1 },
                { q: "D-Day occurred in?", a: ["1942", "1943", "1944", "1945"], c: 2 },
                { q: "Who wrote the Communist Manifesto?", a: ["Lenin", "Stalin", "Marx", "Engels"], c: 2 },
                { q: "The Aztec Empire was in?", a: ["Peru", "Mexico", "Brazil", "Chile"], c: 1 },
                { q: "Who was Joan of Arc?", a: ["English Queen", "French Heroine", "Spanish Princess", "Italian Saint"], c: 1 },
                { q: "The Enlightenment was in which century?", a: ["16th", "17th", "18th", "19th"], c: 2 },
                { q: "Who built the Taj Mahal?", a: ["Akbar", "Shah Jahan", "Aurangzeb", "Babur"], c: 1 },
                { q: "The Boston Tea Party was in?", a: ["1770", "1773", "1775", "1776"], c: 1 },
                { q: "Who was Marco Polo?", a: ["Spanish sailor", "Italian explorer", "Portuguese trader", "English pirate"], c: 1 },
                { q: "The Black Death occurred in?", a: ["1200s", "1300s", "1400s", "1500s"], c: 1 },
                { q: "First woman in space?", a: ["Ride", "Tereshkova", "Jemison", "Collins"], c: 1 }
            ],
            Literature: [
                { q: "Who wrote Hamlet?", a: ["Dickens", "Shakespeare", "Twain", "Homer"], c: 1 },
                { q: "Sherlock's sidekick?", a: ["Wilson", "Watson", "Walker", "Wayne"], c: 1 },
                { q: "Moby Dick is a...?", a: ["Whale", "Shark", "Squid", "Ship"], c: 0 },
                { q: "Author of 1984?", a: ["Huxley", "Orwell", "Bradbury", "Kafka"], c: 1 },
                { q: "Who wrote Frankenstein?", a: ["Austen", "Bronte", "Shelley", "Eliot"], c: 2 },
                { q: "Bilbo is from what book?", a: ["Narnia", "Harry Potter", "The Hobbit", "Dune"], c: 2 },
                { q: "Poet of 'The Raven'?", a: ["Frost", "Poe", "Keats", "Yeats"], c: 1 },
                { q: "The 'Great Gatsby' setting?", a: ["NY", "Chicago", "Paris", "London"], c: 0 },
                { q: "Author of Pride & Prejudice?", a: ["Austen", "Woolf", "Morrison", "Plath"], c: 0 },
                { q: "Detective Hercule...?", a: ["Holmes", "Poirot", "Marple", "Dresden"], c: 1 },
                { q: "Who wrote Romeo and Juliet?", a: ["Marlowe", "Shakespeare", "Jonson", "Milton"], c: 1 },
                { q: "Captain Ahab hunts what?", a: ["Treasure", "A whale", "Pirates", "Land"], c: 1 },
                { q: "Author of Harry Potter?", a: ["King", "Rowling", "Collins", "Meyer"], c: 1 },
                { q: "Who wrote The Odyssey?", a: ["Virgil", "Homer", "Plato", "Sophocles"], c: 1 },
                { q: "Atticus Finch is from?", a: ["1984", "Gatsby", "Mockingbird", "Catcher"], c: 2 },
                { q: "Who wrote Don Quixote?", a: ["Cervantes", "Dante", "Goethe", "Voltaire"], c: 0 },
                { q: "Lord of the Rings author?", a: ["Lewis", "Tolkien", "Martin", "Jordan"], c: 1 },
                { q: "Who wrote War and Peace?", a: ["Dostoevsky", "Tolstoy", "Chekhov", "Pushkin"], c: 1 },
                { q: "Oliver Twist author?", a: ["Dickens", "Austen", "Hardy", "Bronte"], c: 0 },
                { q: "Who wrote The Iliad?", a: ["Homer", "Virgil", "Ovid", "Horace"], c: 0 },
                { q: "Jay Gatsby's love?", a: ["Jordan", "Myrtle", "Daisy", "Catherine"], c: 2 },
                { q: "Who wrote Brave New World?", a: ["Orwell", "Huxley", "Wells", "Verne"], c: 1 },
                { q: "Narrator of The Great Gatsby?", a: ["Gatsby", "Tom", "Nick", "Daisy"], c: 2 },
                { q: "Who wrote Jane Eyre?", a: ["Austen", "C. Bronte", "E. Bronte", "Eliot"], c: 1 },
                { q: "Author of The Catcher in the Rye?", a: ["Fitzgerald", "Hemingway", "Salinger", "Steinbeck"], c: 2 },
                { q: "Who wrote Wuthering Heights?", a: ["C. Bronte", "E. Bronte", "Austen", "Hardy"], c: 1 },
                { q: "Huckleberry Finn author?", a: ["Twain", "Hemingway", "Faulkner", "London"], c: 0 },
                { q: "Who wrote A Tale of Two Cities?", a: ["Dickens", "Thackeray", "Eliot", "Hardy"], c: 0 },
                { q: "Animal Farm author?", a: ["Huxley", "Orwell", "Golding", "Wells"], c: 1 },
                { q: "Who wrote Crime and Punishment?", a: ["Tolstoy", "Dostoevsky", "Gogol", "Turgenev"], c: 1 },
                { q: "The Hunger Games author?", a: ["Roth", "Collins", "Meyer", "Dashner"], c: 1 },
                { q: "Who wrote Les Misérables?", a: ["Dumas", "Hugo", "Balzac", "Zola"], c: 1 },
                { q: "Katniss Everdeen is from?", a: ["Divergent", "Maze Runner", "Hunger Games", "Twilight"], c: 2 },
                { q: "Who wrote The Count of Monte Cristo?", a: ["Hugo", "Dumas", "Verne", "Balzac"], c: 1 },
                { q: "Author of Dracula?", a: ["Shelley", "Stoker", "Poe", "King"], c: 1 },
                { q: "Who wrote The Scarlet Letter?", a: ["Melville", "Hawthorne", "Poe", "Emerson"], c: 1 },
                { q: "Holden Caulfield appears in?", a: ["Gatsby", "Mockingbird", "Catcher in the Rye", "1984"], c: 2 },
                { q: "Who wrote Fahrenheit 451?", a: ["Orwell", "Huxley", "Bradbury", "Asimov"], c: 2 },
                { q: "Author of Of Mice and Men?", a: ["Hemingway", "Steinbeck", "Faulkner", "Fitzgerald"], c: 1 },
                { q: "Who wrote The Old Man and the Sea?", a: ["Hemingway", "Steinbeck", "Faulkner", "Twain"], c: 0 },
                { q: "Scout Finch's father?", a: ["Boo", "Atticus", "Jem", "Tom"], c: 1 },
                { q: "Who wrote Lord of the Flies?", a: ["Orwell", "Golding", "Huxley", "Wells"], c: 1 },
                { q: "Author of The Picture of Dorian Gray?", a: ["Stoker", "Wilde", "Stevenson", "Hardy"], c: 1 },
                { q: "Who wrote Treasure Island?", a: ["Defoe", "Swift", "Stevenson", "Verne"], c: 2 },
                { q: "Name of Harry Potter's owl?", a: ["Errol", "Hedwig", "Pigwidgeon", "Scabbers"], c: 1 },
                { q: "Who wrote The Adventures of Tom Sawyer?", a: ["Twain", "London", "Crane", "Bierce"], c: 0 },
                { q: "Elizabeth Bennet's love interest?", a: ["Bingley", "Darcy", "Wickham", "Collins"], c: 1 },
                { q: "Who wrote Gulliver's Travels?", a: ["Defoe", "Swift", "Pope", "Fielding"], c: 1 },
                { q: "Author of The Grapes of Wrath?", a: ["Hemingway", "Steinbeck", "Fitzgerald", "Faulkner"], c: 1 },
                { q: "Who wrote Slaughterhouse-Five?", a: ["Heller", "Vonnegut", "Kesey", "Pynchon"], c: 1 }
            ],
            'Pop Culture': [
                { q: "Han Solo's ship?", a: ["Enterprise", "Serenity", "Falcon", "TIE"], c: 2 },
                { q: "Color of Pac-Man?", a: ["Red", "Blue", "Yellow", "Orange"], c: 2 },
                { q: "MCU Iron Man actor?", a: ["Evans", "Downey Jr", "Hemsworth", "Pratt"], c: 1 },
                { q: "The 'Queen of Pop'?", a: ["Beyonce", "Lady Gaga", "Madonna", "Rihanna"], c: 2 },
                { q: "Highest grossing film (adjusted)?", a: ["Endgame", "Avatar", "Titanic", "Gone with the Wind"], c: 3 },
                { q: "Batman's real name?", a: ["Wayne", "Kent", "Parker", "Stark"], c: 0 },
                { q: "Pac-Man ghosts number?", a: ["3", "4", "5", "6"], c: 1 },
                { q: "Mario's brother?", a: ["Wario", "Luigi", "Yoshi", "Bowser"], c: 1 },
                { q: "Which band sang 'Help!'?", a: ["Stones", "Zeppelin", "Beatles", "Queen"], c: 2 },
                { q: "Pikachu's element?", a: ["Fire", "Water", "Electric", "Grass"], c: 2 },
                { q: "Superman's home planet?", a: ["Mars", "Krypton", "Vulcan", "Tatooine"], c: 1 },
                { q: "Who directed Jaws?", a: ["Lucas", "Spielberg", "Coppola", "Scorsese"], c: 1 },
                { q: "Taylor Swift's first album?", a: ["Fearless", "Taylor Swift", "Speak Now", "Red"], c: 1 },
                { q: "What is Thor's hammer called?", a: ["Stormbreaker", "Mjolnir", "Gungnir", "Hofund"], c: 1 },
                { q: "Friends coffee shop name?", a: ["Central Perk", "The Hub", "Java Joe's", "Coffee House"], c: 0 },
                { q: "Who played Jack in Titanic?", a: ["Pitt", "DiCaprio", "Damon", "Depp"], c: 1 },
                { q: "What streaming service makes 'Stranger Things'?", a: ["Hulu", "Netflix", "Amazon", "Disney+"], c: 1 },
                { q: "Which Avenger has a shield?", a: ["Thor", "Iron Man", "Hulk", "Captain America"], c: 3 },
                { q: "Singer of 'Bad Guy'?", a: ["Ariana", "Billie Eilish", "Dua Lipa", "Olivia"], c: 1 },
                { q: "What is Baby Yoda's real name?", a: ["Yoda Jr", "Grogu", "Din", "Kuiil"], c: 1 },
                { q: "The Simpsons' hometown?", a: ["Shelbyville", "Springfield", "Quahog", "Langley"], c: 1 },
                { q: "Who sings 'Shape of You'?", a: ["Bieber", "Sheeran", "Mendes", "Styles"], c: 1 },
                { q: "What house is Harry Potter in?", a: ["Slytherin", "Hufflepuff", "Ravenclaw", "Gryffindor"], c: 3 },
                { q: "Name of Ross's dinosaur job?", a: ["Curator", "Paleontologist", "Archaeologist", "Professor"], c: 1 },
                { q: "Which Disney princess has ice powers?", a: ["Anna", "Elsa", "Moana", "Rapunzel"], c: 1 },
                { q: "Who plays Hermione in Harry Potter?", a: ["Watson", "Stone", "Lawrence", "Portman"], c: 0 },
                { q: "What band is Mick Jagger in?", a: ["The Who", "Led Zeppelin", "Rolling Stones", "Pink Floyd"], c: 2 },
                { q: "SpongeBob lives in what city?", a: ["Coral Bay", "Bikini Bottom", "Shell City", "Rock Bottom"], c: 1 },
                { q: "Who created Mickey Mouse?", a: ["Pixar", "Disney", "Warner", "Universal"], c: 1 },
                { q: "What movie features 'Let It Go'?", a: ["Moana", "Frozen", "Tangled", "Coco"], c: 1 },
                { q: "Lead singer of Queen?", a: ["Bowie", "Mercury", "Plant", "Jagger"], c: 1 },
                { q: "Who plays Eleven in Stranger Things?", a: ["Sadie", "Millie", "Winona", "Natalia"], c: 1 },
                { q: "What video game has Master Chief?", a: ["Gears", "Halo", "Destiny", "Call of Duty"], c: 1 },
                { q: "Who is the 'King of Pop'?", a: ["Elvis", "Prince", "Michael Jackson", "Bruno Mars"], c: 2 },
                { q: "What show features Walter White?", a: ["Better Call Saul", "Breaking Bad", "Ozark", "Narcos"], c: 1 },
                { q: "Link is from what game series?", a: ["Mario", "Zelda", "Metroid", "Sonic"], c: 1 },
                { q: "Who directed The Dark Knight?", a: ["Snyder", "Nolan", "Burton", "Reeves"], c: 1 },
                { q: "What anime features Goku?", a: ["Naruto", "One Piece", "Dragon Ball", "Bleach"], c: 2 },
                { q: "Who played the Joker in 2019?", a: ["Ledger", "Leto", "Phoenix", "Nicholson"], c: 2 },
                { q: "What game has Creepers?", a: ["Fortnite", "Minecraft", "Roblox", "Terraria"], c: 1 },
                { q: "Who sang 'Uptown Funk'?", a: ["Pharrell", "Bruno Mars", "The Weeknd", "Usher"], c: 1 },
                { q: "What show has Tyrion Lannister?", a: ["Vikings", "Game of Thrones", "The Witcher", "Lord of Rings"], c: 1 },
                { q: "Who voices Buzz Lightyear?", a: ["Hanks", "Allen", "Rock", "Pratt"], c: 1 },
                { q: "What band sings 'Bohemian Rhapsody'?", a: ["Beatles", "Queen", "Zeppelin", "Pink Floyd"], c: 1 },
                { q: "Spider-Man's alter ego?", a: ["Bruce Wayne", "Clark Kent", "Peter Parker", "Tony Stark"], c: 2 },
                { q: "Who plays Captain Jack Sparrow?", a: ["Pitt", "Depp", "Bloom", "Rush"], c: 1 },
                { q: "What game has 'Battle Royale' on an island?", a: ["PUBG", "Fortnite", "Apex", "All of these"], c: 3 },
                { q: "Who sings 'Blinding Lights'?", a: ["Drake", "Post Malone", "The Weeknd", "Khalid"], c: 2 },
                { q: "What is Darth Vader's real name?", a: ["Luke", "Anakin", "Obi-Wan", "Kylo"], c: 1 },
                { q: "Who plays Wolverine?", a: ["Evans", "Hemsworth", "Jackman", "Reynolds"], c: 2 }
            ]
        };

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAXgfPgLjE0OVbyc8is-Lnieyp_yAzvS90",
            authDomain: "nebula-racers-classroom.firebaseapp.com",
            projectId: "nebula-racers-classroom",
            storageBucket: "nebula-racers-classroom.firebasestorage.app",
            messagingSenderId: "782477105805",
            appId: "1:782477105805:web:6c092112543be5d6eb20c4"
        };

        let db, auth;
        let user = null;
        let roomCode = null;
        let isHost = false;
        let quizMode = 'preset'; // 'preset' or 'custom'
        let selectedSubject = 'Math';
        let customQuestions = [];
        let correctAnswerIdx = 0;
        let myData = { uid: '', tag: 'ACE', color: '#3b82f6', progress: 0, qIdx: 0, finished: false, time: null };
        let gameState = { status: 'lobby', subject: 'Math', questions: [], lastRacerCountdown: null, hostUid: null };
        let activeQuestions = [];
        let startTime = null;
        let raceClock = null;
        let unsubscribers = [];
        let playerCount = 0;

        const getRoomDoc = (subcoll, id) => doc(db, 'games', roomCode, subcoll, id);
        const getRoomColl = (subcoll) => collection(db, 'games', roomCode, subcoll);

        const generateRoomCode = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        };

        window.selectSubject = (s) => {
            selectedSubject = s;
            document.querySelectorAll('.subject-card').forEach(c => {
                c.classList.remove('selected');
                if (c.dataset.subj === s) c.classList.add('selected');
            });
        };

        window.setQuizMode = (mode) => {
            quizMode = mode;
            document.getElementById('btn-preset-quiz').className = mode === 'preset'
                ? 'flex-1 py-3 bg-purple-600 rounded-xl font-bold text-sm transition-all text-white uppercase'
                : 'flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm transition-all text-white uppercase';
            document.getElementById('btn-custom-quiz').className = mode === 'custom'
                ? 'flex-1 py-3 bg-purple-600 rounded-xl font-bold text-sm transition-all text-white uppercase'
                : 'flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm transition-all text-white uppercase';
            document.getElementById('preset-quiz-section').classList.toggle('hidden', mode !== 'preset');
            document.getElementById('custom-quiz-section').classList.toggle('hidden', mode !== 'custom');
            updateLaunchButton();
        };

        window.markCorrect = (idx) => {
            correctAnswerIdx = idx;
            document.querySelectorAll('.answer-input').forEach((el, i) => {
                el.classList.toggle('correct', i === idx);
            });
        };

        window.addCustomQuestion = () => {
            const qText = document.getElementById('custom-question').value.trim();
            const answers = Array.from(document.querySelectorAll('.answer-input')).map(el => el.value.trim());

            if (!qText) return alert('Please enter a question');
            if (answers.some(a => !a)) return alert('Please fill all 4 answers');

            customQuestions.push({
                q: qText,
                a: answers,
                c: correctAnswerIdx
            });

            // Clear form
            document.getElementById('custom-question').value = '';
            document.querySelectorAll('.answer-input').forEach(el => {
                el.value = '';
                el.classList.remove('correct');
            });
            correctAnswerIdx = 0;

            updateQuestionsList();
            updateLaunchButton();
        };

        window.removeQuestion = (idx) => {
            customQuestions.splice(idx, 1);
            updateQuestionsList();
            updateLaunchButton();
        };

        const updateQuestionsList = () => {
            const list = document.getElementById('custom-questions-list');
            document.getElementById('question-count-label').textContent = `${customQuestions.length} / 10 minimum`;

            if (customQuestions.length === 0) {
                list.innerHTML = '<p class="text-slate-500 text-sm italic text-center py-8">No questions yet. Add at least 10!</p>';
                return;
            }

            list.innerHTML = customQuestions.map((q, i) => `
                <div class="question-item glass p-3 rounded-lg">
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-bold text-cyan-400 mb-1">Q${i + 1}</p>
                            <p class="text-sm text-white truncate">${q.q}</p>
                            <p class="text-[10px] text-green-400 mt-1">Answer: ${q.a[q.c]}</p>
                        </div>
                        <button onclick="removeQuestion(${i})" class="text-red-400 hover:text-red-300 text-xs px-2 py-1">✕</button>
                    </div>
                </div>
            `).join('');
        };

        const updateLaunchButton = () => {
            const btn = document.getElementById('btn-launch');
            const warning = document.getElementById('launch-warning');
            const canLaunch = playerCount >= 1 && (quizMode === 'preset' || customQuestions.length >= 10);
            btn.disabled = !canLaunch;
            warning.classList.toggle('hidden', canLaunch);
        };

        window.copyInviteLink = () => {
            const link = document.getElementById('host-invite-link')?.innerText || document.getElementById('invite-link')?.innerText;
            navigator.clipboard.writeText(link);
            const feedback = document.getElementById('host-copy-feedback') || document.getElementById('copy-feedback');
            if (feedback) {
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 2000);
            }
        };

        window.goHome = () => {
            window.location.href = window.location.origin + window.location.pathname;
        };

        const generateQRCode = (url) => {
            const canvas = document.getElementById('host-qr-code');
            if (canvas && typeof QRCode !== 'undefined') {
                QRCode.toCanvas(canvas, url, {
                    width: 120,
                    margin: 1,
                    color: { dark: '#020617', light: '#ffffff' }
                }, (error) => {
                    if (error) console.error('QR Code error:', error);
                });
            }
        };

        window.sendChat = async (source) => {
            const inputId = source === 'host' ? 'host-chat-input' : 'player-chat-input';
            const input = document.getElementById(inputId);
            const message = input.value.trim();
            if (!message || !roomCode || !user) return;

            input.value = '';

            const chatData = {
                text: message,
                uid: user.uid,
                author: isHost ? 'HOST' : (myData.tag || 'ACE'),
                color: isHost ? '#a78bfa' : (myData.color || '#3b82f6'),
                timestamp: Date.now()
            };

            await addDoc(collection(db, 'games', roomCode, 'chat'), chatData);
        };

        const setupChatListener = () => {
            const unsubChat = onSnapshot(
                collection(db, 'games', roomCode, 'chat'),
                (snap) => {
                    const messages = [];
                    snap.forEach(d => messages.push({ id: d.id, ...d.data() }));
                    messages.sort((a, b) => a.timestamp - b.timestamp);

                    const hostContainer = document.getElementById('host-chat-messages');
                    const playerContainer = document.getElementById('player-chat-messages');
                    const container = isHost ? hostContainer : playerContainer;

                    if (container) {
                        const systemMsg = '<div class="chat-message system">Welcome to the lobby!</div>';
                        container.innerHTML = systemMsg + messages.slice(-50).map(m => `
                            <div class="chat-message ${m.uid === user.uid ? 'own' : ''}">
                                <div class="author" style="color: ${m.color}">${m.author}</div>
                                <div>${escapeHtml(m.text)}</div>
                            </div>
                        `).join('');
                        container.scrollTop = container.scrollHeight;
                    }
                }
            );
            unsubscribers.push(unsubChat);
        };

        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // Enter key to send chat
        document.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'host-chat-input') sendChat('host');
                if (document.activeElement.id === 'player-chat-input') sendChat('player');
            }
        });

        const showScreen = (screenId) => {
            ['screen-home', 'screen-host-setup', 'screen-lobby', 'screen-race', 'screen-results'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        };

        const init = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        user = u;
                        myData.uid = u.uid;
                        document.getElementById('connection-overlay').style.display = 'none';

                        const params = new URLSearchParams(window.location.search);
                        const urlRoom = params.get('room');

                        if (urlRoom) {
                            await joinRoom(urlRoom.toUpperCase());
                        } else {
                            showScreen('screen-home');
                        }

                        loadGlobalLeaderboard();
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('connection-status').innerText = "CONNECTION FAILED. CHECK CONSOLE.";
                document.getElementById('connection-status').classList.remove('animate-pulse');
                document.getElementById('retry-btn').classList.remove('hidden');
                document.getElementById('loader-icon').classList.add('hidden');
            }
        };

        const loadGlobalLeaderboard = () => {
            onSnapshot(collection(db, 'leaderboard'), (snap) => {
                const list = [];
                snap.forEach(d => list.push(d.data()));
                const sorted = list.sort((a,b) => parseTime(a.time) - parseTime(b.time)).slice(0, 15);
                const container = document.getElementById('global-leaderboard');
                if (container) {
                    container.innerHTML = sorted.map((r, i) => `
                        <div class="flex justify-between p-2 glass rounded-lg border-l-2 mb-1" style="border-color: ${r.color}">
                            <span class="font-bold text-slate-300 text-[10px]">#${i+1} ${r.tag}</span>
                            <div class="flex gap-3">
                                <span class="text-[8px] text-slate-500 uppercase">${r.subject}</span>
                                <span class="font-mono text-cyan-400 font-bold text-[10px]">${r.time}</span>
                            </div>
                        </div>
                    `).join('') || '<p class="text-slate-500 text-sm italic text-center p-4">HALL OF FAME EMPTY.</p>';
                }
            });
        };

        const hostGame = async () => {
            roomCode = generateRoomCode();
            isHost = true;

            const initialState = {
                status: 'lobby',
                subject: 'Math',
                questions: [],
                lastRacerCountdown: null,
                hostUid: user.uid,
                createdAt: Date.now()
            };
            await setDoc(doc(db, 'games', roomCode, 'state', 'current'), initialState);

            window.history.pushState({}, '', `?room=${roomCode}`);

            const inviteUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
            document.getElementById('host-room-code').innerText = roomCode;
            document.getElementById('host-invite-link').innerText = inviteUrl;

            showScreen('screen-host-setup');
            generateQRCode(inviteUrl);
            setupHostListeners();
        };

        const setupHostListeners = () => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];

            setupChatListener();

            const unsubPlayers = onSnapshot(getRoomColl('players'), (snap) => {
                const players = [];
                snap.forEach(d => players.push(d.data()));
                playerCount = players.length;

                document.getElementById('host-player-count').textContent = `${playerCount} player${playerCount !== 1 ? 's' : ''}`;
                document.getElementById('host-player-list').innerHTML = players.length > 0
                    ? players.map(p => `
                        <div class="glass px-3 py-1.5 rounded-lg border-l-4 text-xs font-bold" style="border-color: ${p.color}">
                            ${p.tag}
                        </div>
                    `).join('')
                    : '<p class="text-slate-500 text-xs italic">Waiting for players to join...</p>';

                updateLaunchButton();
            });
            unsubscribers.push(unsubPlayers);

            const unsubState = onSnapshot(doc(db, 'games', roomCode, 'state', 'current'), (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                const prevStatus = gameState.status;
                gameState = data;
                activeQuestions = gameState.questions || [];

                if (prevStatus === 'lobby' && gameState.status === 'racing') startRaceAsSpectator();
                if (gameState.lastRacerCountdown) handleFinalCountdown();
                if (gameState.status === 'finished') showFinalResults();
                if ((prevStatus === 'finished' || prevStatus === 'racing') && gameState.status === 'lobby') returnToLobby();
            });
            unsubscribers.push(unsubState);
        };

        const joinRoom = async (code) => {
            roomCode = code.toUpperCase();

            const stateDoc = await getDoc(doc(db, 'games', roomCode, 'state', 'current'));
            if (!stateDoc.exists()) {
                alert('Room not found! Check the code and try again.');
                showScreen('screen-home');
                return;
            }

            const state = stateDoc.data();

            // Check if user is the host
            if (state.hostUid === user.uid) {
                isHost = true;
                window.history.pushState({}, '', `?room=${roomCode}`);
                const inviteUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
                document.getElementById('host-room-code').innerText = roomCode;
                document.getElementById('host-invite-link').innerText = inviteUrl;
                showScreen('screen-host-setup');
                generateQRCode(inviteUrl);
                setupHostListeners();
                return;
            }

            isHost = false;
            window.history.pushState({}, '', `?room=${roomCode}`);
            document.getElementById('room-code-display').innerText = roomCode;
            showScreen('screen-lobby');
            setupPlayerListeners();
        };

        const setupPlayerListeners = () => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];

            setupChatListener();

            const unsubState = onSnapshot(doc(db, 'games', roomCode, 'state', 'current'), (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                const prevStatus = gameState.status;
                gameState = data;
                activeQuestions = gameState.questions || [];

                if (prevStatus === 'lobby' && gameState.status === 'racing') startRace();
                if (gameState.lastRacerCountdown) handleFinalCountdown();
                if (gameState.status === 'finished') showFinalResults();
                if ((prevStatus === 'finished' || prevStatus === 'racing') && gameState.status === 'lobby') returnToLobby();
            });
            unsubscribers.push(unsubState);

            const unsubPlayers = onSnapshot(getRoomColl('players'), (snap) => {
                const players = [];
                snap.forEach(d => players.push(d.data()));
                updatePlayerLobby(players);
                if (gameState.status === 'racing') updateTrack(players);
            });
            unsubscribers.push(unsubPlayers);
        };

        const updatePlayerLobby = (players) => {
            const list = document.getElementById('player-list');
            if (list) {
                list.innerHTML = players.map(p => `
                    <div class="glass px-3 py-1.5 rounded-lg border-l-4 text-xs font-bold" style="border-color: ${p.color}">
                        ${p.tag}
                    </div>
                `).join('');
            }
        };

        const updateTrack = (players) => {
            const track = document.getElementById('track');
            if (track.querySelectorAll('.track-lane').length !== players.length) {
                track.innerHTML = '<div class="finish-line"></div>';
                players.sort((a,b) => a.uid.localeCompare(b.uid)).forEach(p => {
                    const lane = document.createElement('div');
                    lane.className = 'track-lane';
                    lane.id = `lane-${p.uid}`;
                    track.appendChild(lane);
                });
            }

            players.forEach(p => {
                const lane = document.getElementById(`lane-${p.uid}`);
                if (!lane) return;
                let ship = lane.querySelector('.ship');
                if (!ship) {
                    ship = document.createElement('div');
                    ship.className = 'ship absolute';
                    lane.appendChild(ship);
                }
                const finalPos = p.finished ? 89 : (p.progress / 100) * 80;
                ship.style.left = `calc(${finalPos}% + 10px)`;
                ship.style.setProperty('--glow', p.color);
                const glow = p.finished ? 'finished-glow' : '';
                ship.innerHTML = `
                    <div class="flex items-center gap-2 ${glow}">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="${p.finished ? '#22c55e' : p.color}" style="transform: rotate(90deg)">
                            <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z"/>
                        </svg>
                        <div class="flex flex-col leading-none">
                            <span class="text-[8px] font-bold" style="color: ${p.color}">${p.tag}</span>
                            ${p.time ? `<span class="text-[8px] font-mono text-green-400 font-bold">${p.time}</span>` : ''}
                        </div>
                    </div>`;
            });

            // Check for first finisher to start countdown (host side)
            if (isHost && gameState.status === 'racing') {
                const finishers = players.filter(p => p.finished).length;
                if (finishers > 0 && !gameState.lastRacerCountdown) {
                    updateDoc(doc(db, 'games', roomCode, 'state', 'current'), {
                        lastRacerCountdown: Date.now() + 30000
                    });
                }
            }
        };

        const startRaceAsSpectator = () => {
            showScreen('screen-race');
            document.getElementById('race-subject-label').innerText = gameState.subject || 'Custom Quiz';
            document.getElementById('spectator-indicator').classList.remove('hidden');
            document.getElementById('btn-end-race').classList.remove('hidden');
            document.getElementById('quiz-ui').classList.add('hidden');
            document.getElementById('question-count').innerText = 'SPECTATING';

            startTime = Date.now();
            raceClock = setInterval(() => {
                document.getElementById('timer-text').innerText = formatMillis(Date.now() - startTime);
            }, 50);

            // Listen to players for track updates
            const unsubPlayers = onSnapshot(getRoomColl('players'), (snap) => {
                const players = [];
                snap.forEach(d => players.push(d.data()));
                updateTrack(players);
            });
            unsubscribers.push(unsubPlayers);
        };

        const startRace = () => {
            showScreen('screen-race');
            document.getElementById('race-subject-label').innerText = gameState.subject || 'Custom Quiz';
            document.getElementById('quiz-ui').classList.remove('hidden');

            startTime = Date.now();
            raceClock = setInterval(() => {
                if (myData.finished) return;
                document.getElementById('timer-text').innerText = formatMillis(Date.now() - startTime);
            }, 50);
            loadQuestion();
        };

        const loadQuestion = () => {
            if (myData.finished || !activeQuestions[myData.qIdx]) return;
            const q = activeQuestions[myData.qIdx];
            document.getElementById('question-count').innerText = `${myData.qIdx + 1} / ${activeQuestions.length}`;
            document.getElementById('question-text').innerText = q.q;
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'p-4 glass rounded-xl hover:bg-slate-700 transition-all text-left font-mono text-sm border border-slate-700 text-white';
                btn.innerText = opt;
                btn.onclick = () => submitAnswer(i);
                grid.appendChild(btn);
            });
        };

        const submitAnswer = async (idx) => {
            const q = activeQuestions[myData.qIdx];
            if (idx === q.c) {
                myData.qIdx++;
                myData.progress = (myData.qIdx / activeQuestions.length) * 100;
                if (myData.qIdx >= activeQuestions.length) {
                    myData.finished = true;
                    myData.time = document.getElementById('timer-text').innerText;
                    await addDoc(collection(db, 'leaderboard'), {
                        tag: myData.tag, time: myData.time, subject: gameState.subject || 'Custom',
                        color: myData.color, timestamp: Date.now()
                    });
                }
                await updateDoc(getRoomDoc('players', user.uid), {
                    progress: myData.progress, qIdx: myData.qIdx,
                    finished: myData.finished, time: myData.time
                });
                if (myData.finished) {
                    document.getElementById('quiz-ui').innerHTML = `<div class="text-center py-4"><h2 class="text-2xl font-bold text-green-400">MISSION SUCCESS</h2><p class="font-mono mt-2">${myData.time}</p></div>`;
                } else loadQuestion();
            } else {
                document.getElementById('penalty-ui').classList.remove('hidden');
                let count = 5.0;
                const interval = setInterval(() => {
                    count -= 0.1;
                    document.querySelector('#penalty-ui p').innerText = `Recalibrating... ${count.toFixed(1)}s`;
                    if (count <= 0) {
                        clearInterval(interval);
                        document.getElementById('penalty-ui').classList.add('hidden');
                    }
                }, 100);
            }
        };

        const formatMillis = (ms) => {
            const m = Math.floor(ms / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            const mil = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
            return `${m}:${s}.${mil}`;
        };

        const parseTime = (t) => {
            if (!t) return 999999;
            const parts = t.split(/[:.]/);
            return (parseInt(parts[0])*60) + parseInt(parts[1]) + (parseInt(parts[2])/100);
        };

        const handleFinalCountdown = () => {
            const container = document.getElementById('final-timer-container');
            container.classList.remove('hidden');
            const timer = document.getElementById('final-timer');
            const update = () => {
                const diff = gameState.lastRacerCountdown - Date.now();
                if (diff <= 0) {
                    timer.innerText = "0s";
                    if (isHost) updateDoc(doc(db, 'games', roomCode, 'state', 'current'), { status: 'finished' });
                    return;
                }
                timer.innerText = Math.ceil(diff / 1000) + 's';
                requestAnimationFrame(update);
            };
            update();
        };

        const showFinalResults = async () => {
            clearInterval(raceClock);
            showScreen('screen-results');
            const snap = await getDocs(getRoomColl('players'));
            const players = [];
            snap.forEach(d => players.push(d.data()));
            const sorted = players.sort((a,b) => {
                if (a.finished && !b.finished) return -1;
                if (!a.finished && b.finished) return 1;
                if (a.finished && b.finished) return parseTime(a.time) - parseTime(b.time);
                return b.progress - a.progress;
            });
            document.getElementById('rankings').innerHTML = sorted.map((p, i) => `
                <div class="glass p-4 rounded-xl flex justify-between items-center border-l-4" style="border-color: ${p.color}">
                    <span class="font-bold">#${i+1} ${p.tag}</span>
                    <span class="font-mono text-cyan-400 font-bold">${p.time || 'DNF'}</span>
                </div>`).join('');

            // Show appropriate controls
            if (isHost) {
                document.getElementById('results-host-controls').classList.remove('hidden');
                document.getElementById('results-player-wait').classList.add('hidden');
            } else {
                document.getElementById('results-host-controls').classList.add('hidden');
                document.getElementById('results-player-wait').classList.remove('hidden');
            }
        };

        window.playAgain = async () => {
            if (!isHost || !roomCode) return;

            // Reset all players' progress
            const snap = await getDocs(getRoomColl('players'));
            const resetPromises = snap.docs.map(d =>
                updateDoc(d.ref, { progress: 0, qIdx: 0, finished: false, time: null })
            );
            await Promise.all(resetPromises);

            // Reset game state to lobby
            await updateDoc(doc(db, 'games', roomCode, 'state', 'current'), {
                status: 'lobby',
                questions: [],
                lastRacerCountdown: null
            });
        };

        const returnToLobby = () => {
            // Reset local player data
            myData.progress = 0;
            myData.qIdx = 0;
            myData.finished = false;
            myData.time = null;

            // Hide results controls
            document.getElementById('results-host-controls').classList.add('hidden');
            document.getElementById('results-player-wait').classList.add('hidden');
            document.getElementById('final-timer-container').classList.add('hidden');

            if (isHost) {
                // Host returns to setup screen
                const inviteUrl = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
                document.getElementById('host-room-code').innerText = roomCode;
                document.getElementById('host-invite-link').innerText = inviteUrl;
                showScreen('screen-host-setup');
                generateQRCode(inviteUrl);
            } else {
                // Player returns to waiting in lobby
                document.getElementById('player-setup-controls').classList.add('hidden');
                document.getElementById('player-lobby-wait').classList.remove('hidden');
                showScreen('screen-lobby');
            }
        };

        // Event Listeners
        document.getElementById('btn-host').onclick = hostGame;

        document.getElementById('btn-join-code').onclick = async () => {
            const code = document.getElementById('join-code').value.trim();
            if (code.length < 4) {
                alert('Please enter a valid room code');
                return;
            }
            await joinRoom(code);
        };

        document.getElementById('btn-join-race').onclick = async () => {
            if (!user || !roomCode) return;
            myData.tag = document.getElementById('player-tag').value.toUpperCase().slice(0,3) || 'ACE';
            myData.color = document.getElementById('player-color').value;
            myData.progress = 0;
            myData.qIdx = 0;
            myData.finished = false;
            myData.time = null;
            await setDoc(getRoomDoc('players', user.uid), { ...myData, uid: user.uid, joinedAt: Date.now() });
            document.getElementById('player-setup-controls').classList.add('hidden');
            document.getElementById('player-lobby-wait').classList.remove('hidden');
        };

        document.getElementById('btn-launch').onclick = async () => {
            if (!user || !isHost) return;

            let questions;
            let subject;

            if (quizMode === 'preset') {
                questions = QUESTIONS_DB[selectedSubject].sort(() => Math.random() - 0.5).slice(0, 10);
                subject = selectedSubject;
            } else {
                questions = customQuestions.sort(() => Math.random() - 0.5);
                subject = document.getElementById('custom-quiz-title').value.trim() || 'Custom Quiz';
            }

            await updateDoc(doc(db, 'games', roomCode, 'state', 'current'), {
                status: 'racing',
                subject: subject,
                questions: questions,
                lastRacerCountdown: null
            });
        };

        document.getElementById('btn-end-race').onclick = async () => {
            if (!isHost || !confirm('End the race now?')) return;
            await updateDoc(doc(db, 'games', roomCode, 'state', 'current'), { status: 'finished' });
        };

        document.getElementById('join-code').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') document.getElementById('btn-join-code').click();
        });

        window.onload = init;

        // Background FX
        const starsBox = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.left = Math.random() * 100 + '%';
            s.style.top = Math.random() * 100 + '%';
            s.style.width = s.style.height = (Math.random() * 2 + 1) + 'px';
            s.style.setProperty('--duration', (2 + Math.random() * 4) + 's');
            starsBox.appendChild(s);
        }
    </script>
</body>
</html>
